// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// المستخدمين
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  fullName      String
  fullNameEn    String?
  role          String    @default("employee") // admin, riskManager, riskAnalyst, riskChampion, executive, employee
  status        String    @default("active") // active, inactive, suspended
  avatar        String?
  phone         String?
  departmentId  String?
  authProvider  String?   // google, microsoft-entra-id, credentials
  lastLogin     DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // العلاقات
  department            Department?            @relation("DepartmentUsers", fields: [departmentId], references: [id])
  managedDepartments    Department[]           @relation("DepartmentManager")
  championDepartments   Department[]           @relation("DepartmentChampion")
  accessibleDepartments UserDepartmentAccess[] // الإدارات التي يمكن للمستخدم الاطلاع عليها
  ownedRisks            Risk[]                 @relation("RiskOwner")
  createdRisks          Risk[]                 @relation("RiskCreator")
  championRisks         Risk[]                 @relation("RiskChampion")
  assessments           RiskAssessment[]       @relation("Assessor")
  responsibleTreatments TreatmentPlan[]        @relation("TreatmentResponsible")
  monitorTreatments     TreatmentPlan[]        @relation("TreatmentMonitor")
  createdTreatments     TreatmentPlan[]        @relation("TreatmentCreator")
  assignedTasks         TreatmentTask[]        @relation("TaskAssignee")
  monitorTasks          TreatmentTask[]        @relation("TaskMonitor")
  reportedIncidents     Incident[]             @relation("IncidentReporter")
  notifications         Notification[]
  auditLogs             AuditLog[]
  riskComments          RiskComment[]          @relation("CommentAuthor")
  riskChangeLogs        RiskChangeLog[]        @relation("RiskChangeLogUser")
  sentDirectMessages    DirectMessage[]        @relation("DirectMessageAuthor")
  receivedDirectMessages DirectMessage[]       @relation("DirectMessageTarget")
  residualRiskChangeRequests ResidualRiskChangeRequest[] @relation("ChangeRequester")
  reviewedResidualRiskChanges ResidualRiskChangeRequest[] @relation("ChangeReviewer")
  riskApprovalRequests       RiskApprovalRequest[] @relation("RiskApprovalRequester")
  reviewedRiskApprovals      RiskApprovalRequest[] @relation("RiskApprovalReviewer")
}

// صلاحيات اطلاع المستخدم على الإدارات
model UserDepartmentAccess {
  id           String   @id @default(cuid())
  userId       String
  departmentId String
  canView      Boolean  @default(true)  // يمكن الاطلاع
  canEdit      Boolean  @default(false) // يمكن التعديل
  createdAt    DateTime @default(now())

  // العلاقات
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  department Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)

  @@unique([userId, departmentId])
}

// الإدارات / الوظائف (Functions)
model Department {
  id              String    @id @default(cuid())
  nameAr          String
  nameEn          String
  code            String    @unique
  type            String    @default("department") // department, function, process
  managerId       String?
  riskChampionId  String?
  parentId        String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // العلاقات
  manager        User?                  @relation("DepartmentManager", fields: [managerId], references: [id])
  riskChampion   User?                  @relation("DepartmentChampion", fields: [riskChampionId], references: [id])
  parent         Department?            @relation("DepartmentHierarchy", fields: [parentId], references: [id])
  children       Department[]           @relation("DepartmentHierarchy")
  users          User[]                 @relation("DepartmentUsers")
  userAccess     UserDepartmentAccess[] // المستخدمون الذين لديهم صلاحية الاطلاع
  risks          Risk[]
  incidents      Incident[]
  processes      Process[]
  riskOwners     RiskOwner[]            @relation("RiskOwnerDepartment")
  directMessages DirectMessage[]        @relation("DirectMessageDepartment")
}

// العمليات (Processes)
model Process {
  id            String    @id @default(cuid())
  nameAr        String
  nameEn        String
  code          String    @unique
  departmentId  String
  parentId      String?   // للعمليات الفرعية (Sub Process)
  isActive      Boolean   @default(true)
  order         Int       @default(0)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // العلاقات
  department  Department  @relation(fields: [departmentId], references: [id])
  parent      Process?    @relation("ProcessHierarchy", fields: [parentId], references: [id])
  children    Process[]   @relation("ProcessHierarchy")
  risks       Risk[]
}

// المخاطر - محدث ليتوافق مع سجل المخاطر الفعلي
model Risk {
  id                   String    @id @default(cuid())
  riskNumber           String    @unique // مثل FIN-R-001, OPS-R-001

  // الجهة المصدرة
  sourceId             String?   // ربط بنموذج RiskSource
  issuedBy             String?   // الجهة المصدرة (للتوافق مع البيانات القديمة)

  // المعلومات الأساسية
  titleAr              String
  titleEn              String
  descriptionAr        String    // وصف الخطر بالعربي
  descriptionEn        String    // وصف الخطر بالإنجليزي

  // التصنيف
  categoryId           String?   // فئة الخطر (مالي، تشغيلي، إلخ)
  departmentId         String    // الوظيفة/الإدارة
  processId            String?   // العملية (للربط مع نموذج Process)

  // العمليات (نص حر كما طلب المستخدم)
  processText          String?   // العملية - Process (نص)
  subProcessText       String?   // العملية الفرعية - Sub Process (نص)

  // تفاصيل الخطر
  potentialCauseAr     String?   // السبب المحتمل بالعربي
  potentialCauseEn     String?   // السبب المحتمل بالإنجليزي
  potentialImpactAr    String?   // التأثير المحتمل بالعربي
  potentialImpactEn    String?   // التأثير المحتمل بالإنجليزي

  // تقييم المخاطر الأصلية (Inherent Risk)
  inherentLikelihood   Int       @default(3) // 1-5
  inherentImpact       Int       @default(3) // 1-5
  inherentScore        Int       @default(9) // محسوب تلقائياً
  inherentRating       String    @default("Minor") // Critical, Major, Moderate, Minor, Negligible

  // تقييم المخاطر المتبقية (Residual Risk)
  residualLikelihood   Int?
  residualImpact       Int?
  residualScore        Int?
  residualRating       String?

  // طبقات الحماية والضوابط
  layersOfProtectionAr String?   // طبقات الحماية بالعربي
  layersOfProtectionEn String?   // طبقات الحماية بالإنجليزي

  // مؤشرات المخاطر الرئيسية (KRIs)
  krisAr               String?   // مؤشرات المخاطر بالعربي
  krisEn               String?   // مؤشرات المخاطر بالإنجليزي

  // إجراءات التخفيف
  mitigationActionsAr  String?   // إجراءات التخفيف بالعربي
  mitigationActionsEn  String?   // إجراءات التخفيف بالإنجليزي

  // الامتثال
  complianceRequired   Boolean   @default(false)
  complianceNoteAr     String?
  complianceNoteEn     String?
  iaRef                String?   // مرجع التدقيق الداخلي

  // الحالة والمتابعة
  status               String    @default("open") // open, inProgress, mitigated, closed, accepted (للتوافقية)
  statusId             String?   // ربط مع جدول حالات المخاطر
  // حالة الموافقة (يستلزم موافقة الإدارة وإدارة المخاطر)
  approvalStatus       String    @default("Draft") // Approved, Draft, Future, N/A, Sent, Under Discussing
  followUpDate         DateTime?

  // الحذف الناعم - الخطر يُعتبر محذوفاً ولكن يبقى في قاعدة البيانات
  isDeleted            Boolean   @default(false)
  deletedAt            DateTime?

  // المسؤولين
  ownerId              String    // مالك الخطر (User - للتوافق القديم)
  riskOwnerId          String?   // مالك الخطر (RiskOwner - الجديد)
  championId           String?   // رائد المخاطر (يجب أن يكون من المستخدمين بدور riskChampion)

  // التواريخ
  identifiedDate       DateTime  @default(now())
  lastReviewDate       DateTime?
  nextReviewDate       DateTime?

  // الإنشاء والتحديث
  createdById          String
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  // العلاقات
  category      RiskCategory?     @relation(fields: [categoryId], references: [id])
  department    Department        @relation(fields: [departmentId], references: [id])
  process       Process?          @relation(fields: [processId], references: [id])
  source        RiskSource?       @relation(fields: [sourceId], references: [id])
  riskStatus    RiskStatus?       @relation(fields: [statusId], references: [id])
  owner         User              @relation("RiskOwner", fields: [ownerId], references: [id])
  riskOwner     RiskOwner?        @relation("RiskToOwner", fields: [riskOwnerId], references: [id])
  champion      User?             @relation("RiskChampion", fields: [championId], references: [id])
  createdBy     User              @relation("RiskCreator", fields: [createdById], references: [id])
  assessments   RiskAssessment[]
  treatments    TreatmentPlan[]
  incidents     Incident[]
  comments      RiskComment[]     // المحادثات والتعليقات على الخطر
  changeLogs    RiskChangeLog[]   // سجل التعديلات على الخطر
  residualRiskChangeRequests ResidualRiskChangeRequest[] // طلبات تغيير الخطر المتبقي
  approvalRequest RiskApprovalRequest? // طلب اعتماد الخطر الجديد

  @@index([categoryId])
  @@index([departmentId])
  @@index([status])
  @@index([statusId])
  @@index([approvalStatus])
  @@index([inherentRating])
  @@index([sourceId])
  @@index([riskOwnerId])
  @@index([isDeleted])
  @@index([createdAt])
  @@index([inherentScore])
  @@index([residualScore])
  @@index([ownerId])
  @@index([championId])
}

// تقييمات المخاطر (سجل التاريخ)
model RiskAssessment {
  id              String    @id @default(cuid())
  riskId          String
  assessmentType  String    // inherent, residual
  likelihood      Int       // 1-5
  impact          Int       // 1-5
  score           Int       // محسوب تلقائياً
  rating          String    // Critical, Major, Moderate, Minor, Negligible
  notesAr         String?
  notesEn         String?
  assessedById    String
  assessmentDate  DateTime
  createdAt       DateTime  @default(now())

  // العلاقات
  risk        Risk  @relation(fields: [riskId], references: [id], onDelete: Cascade)
  assessedBy  User  @relation("Assessor", fields: [assessedById], references: [id])
}

// خطط المعالجة
model TreatmentPlan {
  id              String    @id @default(cuid())
  riskId          String
  titleAr         String
  titleEn         String
  descriptionAr   String
  descriptionEn   String
  strategy        String    // avoid, reduce, transfer, accept
  status          String    @default("notStarted") // notStarted, inProgress, completed, overdue, cancelled
  responsibleId   String    // المسؤول عن خطة المعالجة (من المستخدمين)
  riskOwnerId     String?   // صاحب الخطر (من ملاك المخاطر)
  monitorId       String?   // متابع التنفيذ (من المستخدمين)
  priority        String    @default("medium") // high, medium, low - أولوية المعالجة
  startDate       DateTime
  dueDate         DateTime  // تاريخ الاستحقاق (الموعد النهائي لإغلاق الخطر)
  completionDate  DateTime?
  progress        Int       @default(0)
  cost            Float?

  // تعليق/تبرير خطة المعالجة
  justificationAr   String?   // تبرير/مسببات التعديل (عربي)
  justificationEn   String?   // تبرير/مسببات التعديل (إنجليزي)

  // قياس الأثر بعد المعالجة (Residual Risk المتوقع)
  expectedResidualLikelihood  Int?    // احتمالية الخطر المتبقي المتوقعة
  expectedResidualImpact      Int?    // تأثير الخطر المتبقي المتوقع
  expectedResidualScore       Int?    // درجة الخطر المتبقي المتوقعة
  expectedResidualRating      String? // تصنيف الخطر المتبقي المتوقع

  createdById     String
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // العلاقات
  risk        Risk            @relation(fields: [riskId], references: [id], onDelete: Cascade)
  responsible User            @relation("TreatmentResponsible", fields: [responsibleId], references: [id])
  riskOwner   RiskOwner?      @relation("TreatmentRiskOwner", fields: [riskOwnerId], references: [id])
  monitor     User?           @relation("TreatmentMonitor", fields: [monitorId], references: [id])
  createdBy   User            @relation("TreatmentCreator", fields: [createdById], references: [id])
  tasks       TreatmentTask[]
  residualRiskChangeRequests ResidualRiskChangeRequest[] // طلبات تغيير الخطر المتبقي المرتبطة
}

// مهام المعالجة
model TreatmentTask {
  id                String    @id @default(cuid())
  treatmentPlanId   String
  titleAr           String
  titleEn           String
  descriptionAr     String?
  descriptionEn     String?
  status            String    @default("notStarted") // notStarted, inProgress, completed, overdue, cancelled
  priority          String    @default("medium") // high, medium, low - أولوية المهمة
  assignedToId      String?   // منفذ الإجراء (من Users - للتوافق القديم)
  actionOwnerId     String?   // منفذ الإجراء (من ملاك المخاطر)
  monitorId         String?   // متابع التنفيذ (من المستخدمين - للتوافق القديم)
  monitorOwnerId    String?   // متابع التنفيذ (من ملاك المخاطر)
  successIndicatorAr String?  // مؤشر الإنجاز بالعربي (كيف يعرف المتابع أن المهمة تمت)
  successIndicatorEn String?  // مؤشر الإنجاز بالإنجليزي
  dueDate           DateTime? // تاريخ الاستحقاق
  completionDate    DateTime?
  order             Int       @default(0)
  // مرفقات OneDrive
  oneDriveUrl       String?   // رابط الملف في OneDrive/SharePoint
  oneDriveFileName  String?   // اسم الملف المرفق
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // العلاقات
  treatmentPlan TreatmentPlan @relation(fields: [treatmentPlanId], references: [id], onDelete: Cascade)
  assignedTo    User?         @relation("TaskAssignee", fields: [assignedToId], references: [id])
  actionOwner   RiskOwner?    @relation("TaskActionOwner", fields: [actionOwnerId], references: [id])
  monitor       User?         @relation("TaskMonitor", fields: [monitorId], references: [id])
  monitorOwner  RiskOwner?    @relation("TaskMonitorOwner", fields: [monitorOwnerId], references: [id])
}

// الحوادث
model Incident {
  id                   String    @id @default(cuid())
  incidentNumber       String    @unique
  titleAr              String
  titleEn              String
  descriptionAr        String
  descriptionEn        String
  incidentDate         DateTime
  reportedDate         DateTime
  severity             String    // critical, major, moderate, minor
  status               String    @default("reported") // reported, investigating, resolved, closed
  departmentId         String
  reportedById         String
  relatedRiskId        String?
  rootCauseAr          String?
  rootCauseEn          String?
  correctiveActionsAr  String?
  correctiveActionsEn  String?
  lessonsLearnedAr     String?
  lessonsLearnedEn     String?
  resolvedDate         DateTime?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  // العلاقات
  department   Department @relation(fields: [departmentId], references: [id])
  reportedBy   User       @relation("IncidentReporter", fields: [reportedById], references: [id])
  relatedRisk  Risk?      @relation(fields: [relatedRiskId], references: [id])
}

// الإشعارات
model Notification {
  id         String    @id @default(cuid())
  userId     String
  type       String    // newRisk, riskUpdated, treatmentDue, incidentReported, reviewReminder
  titleAr    String
  titleEn    String
  messageAr  String
  messageEn  String
  link       String?
  isRead     Boolean   @default(false)
  createdAt  DateTime  @default(now())

  // العلاقات
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// سجل التدقيق
model AuditLog {
  id         String    @id @default(cuid())
  userId     String
  action     String    // create, update, delete, login, logout, export, import
  entity     String
  entityId   String?
  oldValues  String?   // JSON string
  newValues  String?   // JSON string
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime  @default(now())

  // العلاقات
  user  User  @relation(fields: [userId], references: [id])
}

// إعدادات النظام
model SystemSettings {
  id        String    @id @default(cuid())
  key       String    @unique
  value     String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

// تصنيفات المخاطر
model RiskCategory {
  id            String    @id @default(cuid())
  code          String    @unique // FIN, OPS, COMP, HSE, HR, TECH, REP
  nameAr        String
  nameEn        String
  descriptionAr String?
  descriptionEn String?
  examplesAr    String?   // أمثلة على المخاطر
  examplesEn    String?
  color         String?
  icon          String?
  isActive      Boolean   @default(true)
  order         Int       @default(0)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // العلاقات
  risks         Risk[]
}

// مصادر المخاطر (الجهة المصدرة)
model RiskSource {
  id            String    @id @default(cuid())
  code          String    @unique // مثل: KPMG, INT, EXT, AUD
  nameAr        String
  nameEn        String
  descriptionAr String?
  descriptionEn String?
  isActive      Boolean   @default(true)
  order         Int       @default(0)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // العلاقات
  risks         Risk[]
}

// حالات المخاطر (Risk Status)
model RiskStatus {
  id            String    @id @default(cuid())
  code          String    @unique // open, inProgress, closed, mitigated
  nameAr        String
  nameEn        String
  descriptionAr String?
  descriptionEn String?
  color         String?   // لون الشارة
  icon          String?   // أيقونة الحالة
  isDefault     Boolean   @default(false) // الحالة الافتراضية للمخاطر الجديدة
  isActive      Boolean   @default(true)
  order         Int       @default(0)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // العلاقات
  risks         Risk[]
}

// ملاك المخاطر (Risk Owners)
model RiskOwner {
  id            String    @id @default(cuid())
  fullName      String
  fullNameEn    String?
  email         String?
  phone         String?
  departmentId  String?
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // العلاقات
  department         Department?      @relation("RiskOwnerDepartment", fields: [departmentId], references: [id])
  risks              Risk[]           @relation("RiskToOwner")
  treatmentPlans     TreatmentPlan[]  @relation("TreatmentRiskOwner")
  treatmentTasks     TreatmentTask[]  @relation("TaskActionOwner")
  monitoredTasks     TreatmentTask[]  @relation("TaskMonitorOwner")
}

// معايير الاحتمالية
model LikelihoodCriteria {
  id            String    @id @default(cuid())
  level         Int       @unique // 1-5
  nameAr        String    // نادر، غير محتمل، إلخ
  nameEn        String    // Rare, Unlikely, etc.
  descriptionAr String    // وصف تفصيلي
  descriptionEn String
  percentage    String?   // مثل "أقل من 5%"
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

// معايير التأثير
model ImpactCriteria {
  id            String    @id @default(cuid())
  level         Int       @unique // 1-5
  nameAr        String    // ضئيل، طفيف، إلخ
  nameEn        String    // Negligible, Minor, etc.
  descriptionAr String
  descriptionEn String
  // التأثير حسب الفئة
  financialAr   String?   // التأثير المالي
  financialEn   String?
  operationalAr String?   // التأثير التشغيلي
  operationalEn String?
  reputationalAr String?  // التأثير على السمعة
  reputationalEn String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

// تصنيف مستوى الخطر
model RiskRatingCriteria {
  id            String    @id @default(cuid())
  minScore      Int       // الحد الأدنى للنتيجة
  maxScore      Int       // الحد الأقصى للنتيجة
  nameAr        String    // حرج، عالي، إلخ
  nameEn        String    // Critical, High, etc.
  descriptionAr String    // الإجراء المطلوب
  descriptionEn String
  color         String    // لون العرض
  actionRequiredAr String? // الإجراء المطلوب
  actionRequiredEn String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

// تعليقات ومحادثات المخاطر
model RiskComment {
  id          String    @id @default(cuid())
  riskId      String
  authorId    String
  content     String    // محتوى التعليق
  type        String    @default("comment") // comment, question, reply, statusUpdate, approval
  parentId    String?   // للرد على تعليق آخر
  isInternal  Boolean   @default(false) // تعليق داخلي لإدارة المخاطر فقط
  attachments String?   // روابط المرفقات (JSON)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // العلاقات
  risk        Risk          @relation(fields: [riskId], references: [id], onDelete: Cascade)
  author      User          @relation("CommentAuthor", fields: [authorId], references: [id])
  parent      RiskComment?  @relation("CommentReplies", fields: [parentId], references: [id])
  replies     RiskComment[] @relation("CommentReplies")

  @@index([riskId])
  @@index([authorId])
  @@index([parentId])
}

// الرسائل المباشرة (بدون خطر)
model DirectMessage {
  id                  String    @id @default(cuid())
  authorId            String
  content             String    // محتوى الرسالة
  type                String    @default("message") // message, question, announcement
  targetType          String    @default("department") // department, user
  targetDepartmentId  String?   // الإدارة المستهدفة
  targetUserId        String?   // المستخدم المستهدف
  parentId            String?   // للرد على رسالة أخرى
  attachments         String?   // روابط المرفقات (JSON)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  // العلاقات
  author            User             @relation("DirectMessageAuthor", fields: [authorId], references: [id])
  targetDepartment  Department?      @relation("DirectMessageDepartment", fields: [targetDepartmentId], references: [id])
  targetUser        User?            @relation("DirectMessageTarget", fields: [targetUserId], references: [id])
  parent            DirectMessage?   @relation("DirectMessageReplies", fields: [parentId], references: [id])
  replies           DirectMessage[]  @relation("DirectMessageReplies")

  @@index([authorId])
  @@index([targetDepartmentId])
  @@index([targetUserId])
  @@index([parentId])
  @@index([createdAt])
}

// سجل تعديلات المخاطر
model RiskChangeLog {
  id              String    @id @default(cuid())
  riskId          String
  userId          String
  changeType      String    // create, update, delete, treatment_add, treatment_update, treatment_delete, assessment_add, status_change
  changeCategory  String    // risk_info, assessment, treatment, status, ownership
  fieldName       String?   // اسم الحقل المتغير (إذا كان التغيير على حقل محدد)
  fieldNameAr     String?   // اسم الحقل بالعربي
  oldValue        String?   // القيمة القديمة (JSON للقيم المعقدة)
  newValue        String?   // القيمة الجديدة (JSON للقيم المعقدة)
  description     String?   // وصف التغيير
  descriptionAr   String?   // وصف التغيير بالعربي
  relatedEntityId String?   // معرف الكيان المرتبط (مثل معرف خطة المعالجة)
  ipAddress       String?
  userAgent       String?
  createdAt       DateTime  @default(now())

  // العلاقات
  risk  Risk  @relation(fields: [riskId], references: [id], onDelete: Cascade)
  user  User  @relation("RiskChangeLogUser", fields: [userId], references: [id])

  @@index([riskId])
  @@index([userId])
  @@index([changeType])
  @@index([createdAt])
}

// طلبات تغيير الخطر المتبقي (Residual Risk Change Requests)
model ResidualRiskChangeRequest {
  id                      String    @id @default(cuid())
  riskId                  String
  requesterId             String    // المستخدم الذي طلب التغيير
  treatmentPlanId         String?   // خطة المعالجة المرتبطة (إن وجدت)

  // القيم الحالية
  currentLikelihood       Int?
  currentImpact           Int?
  currentScore            Int?
  currentRating           String?

  // القيم المقترحة
  proposedLikelihood      Int
  proposedImpact          Int
  proposedScore           Int       // محسوب تلقائياً
  proposedRating          String    // محسوب تلقائياً

  // التبرير
  justificationAr         String    // سبب التعديل بالعربي
  justificationEn         String?   // سبب التعديل بالإنجليزي

  // الموافقة
  status                  String    @default("pending") // pending, approved, rejected, auto_approved
  reviewerId              String?   // مدير المخاطر الذي راجع الطلب
  reviewNoteAr            String?   // ملاحظات المراجعة بالعربي
  reviewNoteEn            String?   // ملاحظات المراجعة بالإنجليزي
  reviewedAt              DateTime?

  // نوع الطلب
  requestType             String    @default("manual") // manual (تعديل يدوي), treatment_completion (إكمال خطة معالجة)

  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt

  // العلاقات
  risk          Risk            @relation(fields: [riskId], references: [id], onDelete: Cascade)
  requester     User            @relation("ChangeRequester", fields: [requesterId], references: [id])
  reviewer      User?           @relation("ChangeReviewer", fields: [reviewerId], references: [id])
  treatmentPlan TreatmentPlan?  @relation(fields: [treatmentPlanId], references: [id])

  @@index([riskId])
  @@index([requesterId])
  @@index([reviewerId])
  @@index([status])
  @@index([createdAt])
}

// طلبات اعتماد المخاطر الجديدة (New Risk Approval Requests)
model RiskApprovalRequest {
  id                      String    @id @default(cuid())
  riskId                  String    @unique  // الخطر المطلوب اعتماده (فريد لكل خطر)
  requesterId             String    // المستخدم الذي أرسل الخطر للاعتماد

  // حالة الطلب
  status                  String    @default("pending") // pending, approved, rejected, deferred, revision_requested

  // المراجعة
  reviewerId              String?   // مدير المخاطر الذي راجع الطلب
  reviewNoteAr            String?   // ملاحظات المراجعة بالعربي
  reviewNoteEn            String?   // ملاحظات المراجعة بالإنجليزي
  reviewedAt              DateTime?

  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt

  // العلاقات
  risk          Risk    @relation(fields: [riskId], references: [id], onDelete: Cascade)
  requester     User    @relation("RiskApprovalRequester", fields: [requesterId], references: [id])
  reviewer      User?   @relation("RiskApprovalReviewer", fields: [reviewerId], references: [id])

  @@index([riskId])
  @@index([requesterId])
  @@index([reviewerId])
  @@index([status])
  @@index([createdAt])
}
