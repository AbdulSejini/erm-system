import { NextResponse } from 'next/server';
import prisma from '@/lib/prisma';
import { auth } from '@/lib/auth';

// --- Mapping helpers ---

const domainArToEn: Record<string, string> = {
  'مجلس الإدارة': 'Board of Directors',
  'لجنة المراجعة': 'Audit Committee',
  'لجنة الترشيحات والمكافآت': 'Nomination & Remuneration Committee',
  'لجنة إدارة المخاطر': 'Risk Management Committee',
  'الإفصاح والشفافية': 'Disclosure & Transparency',
  'تعارض المصالح': 'Conflict of Interest',
  'الرقابة الداخلية': 'Internal Controls',
  'حظر التداول': 'Insider Trading',
  'الإبلاغ عن المخالفات': 'Whistleblowing',
  'حقوق المساهمين': 'Shareholder Rights',
  'المكافآت والتعويضات': 'Compensation & Benefits',
  'الالتزامات الضريبية والزكوية': 'Tax & Zakat',
  'ضريبة القيمة المضافة': 'VAT',
  'نظام العمل': 'Labor Law',
  'السعودة ونطاقات': 'Saudization & Nitaqat',
  'التأمينات الاجتماعية': 'Social Insurance',
  'السلامة والصحة المهنية': 'HSE',
  'البيئة': 'Environment',
  'الترخيص الصناعي': 'Industrial License',
  'المواصفات والمقاييس': 'Standards & Quality',
  'حماية البيانات والخصوصية': 'Data Privacy',
  'الأمن السيبراني': 'Cybersecurity',
  'التنظيم المالي': 'Financial Restructuring',
  'السجل التجاري والتراخيص البلدية': 'Commercial Registration',
  'مكافحة غسل الأموال': 'AML',
  'المنافسة': 'Competition',
  'حفظ الوثائق': 'Document Retention',
  'المراجع الخارجي': 'External Auditor',
  'قواعد السلوك والأخلاقيات': 'Code of Conduct',
  'إدارة الجودة': 'Quality Management',
  'الجمارك والاستيراد/التصدير': 'Customs & Trade',
  'المسؤولية الاجتماعية': 'CSR',
  'مصفوفة الصلاحيات': 'Authority Matrix',
  'الملكية الفكرية': 'Intellectual Property',
};

const regulatoryBodyArToEn: Record<string, string> = {
  'هيئة السوق المالية (CMA)': 'Capital Market Authority (CMA)',
  'وزارة التجارة': 'Ministry of Commerce',
  'هيئة الزكاة والضريبة والجمارك (ZATCA)': 'Zakat, Tax and Customs Authority (ZATCA)',
  'وزارة الموارد البشرية والتنمية الاجتماعية': 'Ministry of HR & Social Development (HRSD)',
  'المؤسسة العامة للتأمينات الاجتماعية': 'General Organization for Social Insurance (GOSI)',
  'الدفاع المدني': 'Civil Defense',
  'المركز الوطني للرقابة على الالتزام البيئي': 'National Center for Environmental Compliance (NCEC)',
  'وزارة الصناعة والثروة المعدنية': 'Ministry of Industry & Mineral Resources',
  'الهيئة السعودية للمواصفات والمقاييس (SASO)': 'Saudi Standards Organization (SASO)',
  'الهيئة السعودية للبيانات والذكاء الاصطناعي': 'Saudi Data & AI Authority (SDAIA)',
  'الهيئة الوطنية للأمن السيبراني': 'National Cybersecurity Authority (NCA)',
  'لجنة التنظيم المالي': 'Financial Restructuring Committee',
  'أمانة جدة': 'Jeddah Municipality',
  'الهيئة العامة للمنافسة': 'General Authority for Competition',
  'جهة الاعتماد الدولية': 'International Accreditation Body',
  'مجلس الإدارة (داخلي)': 'Board of Directors (Internal)',
  'الهيئة السعودية للملكية الفكرية': 'Saudi IP Authority (SAIP)',
};

const regulatoryBodyArToCode: Record<string, string> = {
  'هيئة السوق المالية (CMA)': 'CMA',
  'وزارة التجارة': 'MOCI',
  'هيئة الزكاة والضريبة والجمارك (ZATCA)': 'ZATCA',
  'وزارة الموارد البشرية والتنمية الاجتماعية': 'HRSD',
  'المؤسسة العامة للتأمينات الاجتماعية': 'GOSI',
  'الدفاع المدني': 'CD',
  'المركز الوطني للرقابة على الالتزام البيئي': 'NCEC',
  'وزارة الصناعة والثروة المعدنية': 'MIMR',
  'الهيئة السعودية للمواصفات والمقاييس (SASO)': 'SASO',
  'الهيئة السعودية للبيانات والذكاء الاصطناعي': 'SDAIA',
  'الهيئة الوطنية للأمن السيبراني': 'NCA',
  'لجنة التنظيم المالي': 'FRC',
  'أمانة جدة': 'JEDDAH',
  'الهيئة العامة للمنافسة': 'GAC',
  'جهة الاعتماد الدولية': 'IAB',
  'مجلس الإدارة (داخلي)': 'BOD-INT',
  'الهيئة السعودية للملكية الفكرية': 'SAIP',
};

const statusArToEnum: Record<string, string> = {
  'ملتزم': 'compliant',
  'ملتزم جزئياً': 'partiallyCompliant',
  'غير ملتزم': 'nonCompliant',
  'غير مُقيَّم': 'notAssessed',
};

const criticalityArToEnum: Record<string, string> = {
  'حرج': 'critical',
  'مرتفع': 'high',
  'متوسط': 'medium',
  'منخفض': 'low',
};

const recurrenceArToEnum: Record<string, string> = {
  'سنوي': 'annual',
  'ربع سنوي': 'quarterly',
  'شهري': 'monthly',
  'مستمر': 'continuous',
  'فوري / عند الحدث': 'perEvent',
  'كل اجتماع': 'perMeeting',
};

const obligationTypeArToEnum: Record<string, string> = {
  'إلزامي': 'mandatory',
  'اختياري (أفضل الممارسات)': 'optional',
  'استرشادي': 'advisory',
};

const defenseLineArToEnum: Record<string, string> = {
  'خط الدفاع الأول': 'first',
  'خط الدفاع الثاني': 'second',
  'خط الدفاع الثالث': 'third',
};

const testingMethodArToEnum: Record<string, string> = {
  'مراجعة وثائقية': 'documentReview',
  'فحص ميداني': 'fieldInspection',
  'تحليل بيانات': 'dataAnalysis',
  'تقييم ذاتي': 'selfAssessment',
  'اختبار تشغيلي': 'operationalTest',
  'مراجعة خارجية': 'externalAudit',
};

const testResultArToEnum: Record<string, string> = {
  'مجتاز': 'passed',
  'جزئي': 'partial',
  'فاشل': 'failed',
  'لم يُختبر': 'notTested',
};

const remediationStatusArToEnum: Record<string, string> = {
  'قيد التنفيذ': 'inProgress',
  'لم تبدأ': 'notStarted',
  'مكتمل': 'completed',
};

function computeRiskRating(score: number): string {
  if (score >= 20) return 'critical';
  if (score >= 12) return 'high';
  if (score >= 6) return 'medium';
  if (score >= 2) return 'low';
  return 'veryLow';
}

function extractDomainCode(obligationCode: string): string {
  // CMP-BOD-001 → BOD, CMP-AUC-001 → AUC
  const parts = obligationCode.split('-');
  return parts[1];
}

// --- Raw data (68 rows) ---
// Fields: [code, seq, domainAr, subDomainAr, titleAr, titleEn, regulatoryRef, articleNum, internalPolicyAr, policyDocNum, regulatoryBodyAr, obligationType, responsibleDeptAr, directOwnerAr, backupOwnerAr, defenseLine, recurrence, nextDueDate, lastReviewDate, nextReviewDate, alertDays, criticalityAr, likelihood, impact, riskScore, riskRating, penaltiesAr, statusAr, completionPct, controlActivitiesAr, testingMethodAr, lastTestResultAr, lastTestDate, evidenceReqAr, gapDescAr, remediationPlanAr, remediationTargetDate, remediationOwnerAr, remediationStatusAr, linkedRiskNumbers, kpiKri, notes]

type ObligationRow = [
  string, number, string, string, string, string, string | null, string | null,
  string | null, string | null, string | null, string, string | null, string | null,
  string | null, string | null, string | null, string | null, string | null,
  string | null, number | null, string | null, number | null, number | null,
  number | null, string | null, string | null, string | null, number | null,
  string | null, string | null, string | null, string | null, string | null,
  string | null, string | null, string | null, string | null, string | null,
  string | null, string | null, string | null
];

const obligationsData: ObligationRow[] = [
  ["CMP-BOD-001", 1, "مجلس الإدارة", "اجتماعات المجلس", "عقد 4 اجتماعات على الأقل سنوياً لمجلس الإدارة", "Hold at least 4 board meetings annually", "لائحة الحوكمة", "المادة 18", "نظام حوكمة الشركة - الباب الثالث", "POL-GOV-001", "هيئة السوق المالية (CMA)", "إلزامي", "أمانة المجلس", "أمين سر المجلس", "مساعد أمين السر", "خط الدفاع الأول", "ربع سنوي", null, null, null, 30, "حرج", 2, 5, null, null, "غرامة تصل إلى 100,000 ريال / ملاحظة في تقرير الحوكمة", "ملتزم", 1, "جدول اجتماعات سنوي معتمد / متابعة أمانة المجلس", "مراجعة وثائقية", "مجتاز", null, "محاضر الاجتماعات الموقعة / سجل الحضور", null, null, null, null, null, "GOV-R-222", "KRI-GOV-01", null],
  ["CMP-BOD-002", 2, "مجلس الإدارة", "اجتماعات المجلس", "حضور 5 أعضاء على الأقل (4 أصالة) كنصاب قانوني", "Quorum of at least 5 members (4 in person)", "لائحة الحوكمة", "المادة 19", "نظام حوكمة الشركة", "POL-GOV-001", "هيئة السوق المالية (CMA)", "إلزامي", "أمانة المجلس", "أمين سر المجلس", "مساعد أمين السر", "خط الدفاع الأول", "كل اجتماع", null, null, null, 7, "حرج", 1, 5, null, null, "بطلان قرارات المجلس / مسؤولية قانونية", "ملتزم", 1, "التحقق من النصاب قبل بدء الاجتماع", "مراجعة وثائقية", "مجتاز", null, "سجل الحضور والغياب لكل اجتماع", null, null, null, null, null, "GOV-R-222", null, null],
  ["CMP-BOD-003", 3, "مجلس الإدارة", "اجتماعات المجلس", "الدعوة لاجتماع المجلس قبل 5 أيام على الأقل", "Notify board members at least 5 days before meeting", "نظام الشركات", "المادة 70", "نظام حوكمة الشركة", "POL-GOV-001", "وزارة التجارة", "إلزامي", "أمانة المجلس", "أمين سر المجلس", null, "خط الدفاع الأول", "كل اجتماع", null, null, null, 10, "مرتفع", 1, 4, null, null, "بطلان الاجتماع إذا لم يُبلّغ الأعضاء", "ملتزم", 1, "نظام تنبيهات إلكتروني", "مراجعة وثائقية", "مجتاز", null, "خطابات الدعوة / البريد الإلكتروني", null, null, null, null, null, "GOV-R-245", null, null],
  ["CMP-BOD-004", 4, "مجلس الإدارة", "اجتماعات المجلس", "توثيق اجتماعات المجلس وإعداد المحاضر وتوقيعها", "Document board meetings, prepare and sign minutes", "نظام الشركات", "المادة 70", "نظام حوكمة الشركة - المادة 5", "POL-GOV-001", "وزارة التجارة", "إلزامي", "أمانة المجلس", "أمين سر المجلس", null, "خط الدفاع الأول", "كل اجتماع", null, null, null, 7, "حرج", 2, 4, null, null, "غرامة / بطلان القرارات", "ملتزم", 1, "قالب موحد للمحاضر / مراجعة قانونية", "مراجعة وثائقية", "مجتاز", null, "المحاضر الموقعة / سجل القرارات", null, null, null, null, null, "GOV-R-245", null, null],
  ["CMP-BOD-005", 5, "مجلس الإدارة", "السياسات واللوائح", "المراجعة السنوية لكافة سياسات ولوائح المجلس واللجان", "Annual review of all board and committee policies", "لائحة الحوكمة", "المادة 22", "نظام حوكمة الشركة - المادة 4", "POL-GOV-001", "هيئة السوق المالية (CMA)", "إلزامي", "الالتزام والحوكمة", "مدير الالتزام", null, "خط الدفاع الثاني", "سنوي", null, null, null, 60, "مرتفع", 3, 4, null, null, "ملاحظة في تقرير الحوكمة السنوي", "ملتزم جزئياً", 0.7, "جدول مراجعة سنوي / لجنة مراجعة السياسات", "مراجعة وثائقية", "جزئي", null, "سجل مراجعة السياسات / محاضر الاعتماد", "بعض السياسات لم تُراجع منذ أكثر من سنة", "جدولة مراجعة جميع السياسات خلال Q2 2026", "2026-06-30", "مدير الالتزام", "قيد التنفيذ", "GOV-R-757, GOV-R-224", "KRI-GOV-03", null],
  ["CMP-BOD-006", 6, "مجلس الإدارة", "الخطط والاستراتيجيات", "وضع الخطط والسياسات والاستراتيجيات الرئيسة والإشراف على تنفيذها", "Develop key plans, policies and strategies and oversee implementation", "لائحة الحوكمة", "المادة 22", "نظام حوكمة الشركة - المادة 4", "POL-GOV-001", "هيئة السوق المالية (CMA)", "إلزامي", "مجلس الإدارة", "رئيس المجلس", null, "خط الدفاع الأول", "سنوي", null, null, null, 60, "حرج", 2, 5, null, null, "ملاحظة رقابية / ضعف الحوكمة", "ملتزم", 1, "خطة استراتيجية معتمدة / متابعة دورية", "مراجعة وثائقية", "مجتاز", null, "الخطة الاستراتيجية / محاضر متابعة التنفيذ", null, null, null, null, null, "GOV-R-757", null, null],
  ["CMP-BOD-007", 7, "مجلس الإدارة", "تقييم الأداء", "تقييم أداء المجلس واللجان والأعضاء سنوياً", "Annual performance evaluation of board, committees and members", "لائحة الحوكمة", "المادة 41", "نظام حوكمة الشركة - المادة 14", "POL-GOV-001", "هيئة السوق المالية (CMA)", "إلزامي", "الالتزام والحوكمة", "مدير الالتزام", null, "خط الدفاع الثاني", "سنوي", null, null, null, 60, "مرتفع", 3, 4, null, null, "ملاحظة في تقرير الحوكمة", "ملتزم جزئياً", 0.6, "نماذج تقييم معتمدة", "تقييم ذاتي", "جزئي", null, "نماذج التقييم المكتملة / تقرير النتائج", "لم يتم الاستعانة بجهة خارجية للتقييم", "التعاقد مع جهة خارجية للتقييم", "2026-12-31", "مدير الالتزام", "قيد التنفيذ", "GOV-R-242", "KRI-GOV-02", null],
  ["CMP-BOD-008", 8, "مجلس الإدارة", "التقارير", "إعداد واعتماد تقرير المجلس السنوي قبل نشره", "Prepare and approve annual board report before publication", "نظام الشركات / لائحة الحوكمة", "المادة 76", "نظام حوكمة الشركة - المادة 4", "POL-GOV-001", "هيئة السوق المالية (CMA)", "إلزامي", "الالتزام والحوكمة", "مدير الالتزام", null, "خط الدفاع الثاني", "سنوي", null, null, null, 90, "حرج", 2, 5, null, null, "غرامة مالية / وقف تداول", "ملتزم", 1, "جدول إعداد التقرير / مراجعة متعددة المراحل", "مراجعة وثائقية", "مجتاز", null, "تقرير المجلس المعتمد / محضر الاعتماد", null, null, null, null, null, "GOV-R-756", null, null],
  ["CMP-BOD-009", 9, "مجلس الإدارة", "تعارض المصالح", "استكمال نموذج التعهد بالالتزام بسياسة تعارض المصالح سنوياً", "Complete annual conflict of interest declaration form", "نظام حوكمة الشركة", "المادة 10", "سياسة تعارض المصالح", "POL-GOV-003", "هيئة السوق المالية (CMA)", "إلزامي", "أمانة المجلس", "أمين سر المجلس", null, "خط الدفاع الأول", "سنوي", null, null, null, 30, "حرج", 2, 5, null, null, "مساءلة قانونية / غرامات", "ملتزم", 1, "نماذج إفصاح سنوية / متابعة أمانة المجلس", "مراجعة وثائقية", "مجتاز", null, "نماذج الإفصاح الموقعة من جميع الأعضاء", null, null, null, null, null, "GOV-R-241, GOV-R-236", null, null],
  ["CMP-BOD-010", 10, "مجلس الإدارة", "تعارض المصالح", "إبلاغ الجمعية العامة بالأعمال والعقود التي لأحد أعضاء المجلس مصلحة فيها", "Disclose to GA any contracts in which a board member has interest", "نظام الشركات", "المادة 71", "سياسة تعارض المصالح", "POL-GOV-003", "وزارة التجارة", "إلزامي", "أمانة المجلس", "رئيس المجلس", "أمين سر المجلس", "خط الدفاع الأول", "فوري / عند الحدث", null, null, null, 7, "حرج", 2, 5, null, null, "بطلان العقود / مسؤولية شخصية", "ملتزم", 1, "سجل الأطراف ذوي العلاقة / مراجعة قانونية", "مراجعة وثائقية", "مجتاز", null, "محضر الجمعية / سجل الإفصاحات", null, null, null, null, null, "GOV-R-241", null, null],
  ["CMP-AUC-001", 11, "لجنة المراجعة", "اجتماعات اللجنة", "عقد اجتماعات ربع سنوية على الأقل", "Hold at least quarterly meetings", "لائحة الحوكمة", "المادة 54", "نظام حوكمة الشركة - المادة 9", "POL-GOV-002", "هيئة السوق المالية (CMA)", "إلزامي", "أمانة المجلس", "رئيس لجنة المراجعة", null, "خط الدفاع الأول", "ربع سنوي", null, null, null, 30, "حرج", 2, 4, null, null, "غرامة من الهيئة", "ملتزم", 1, "جدول اجتماعات سنوي", "مراجعة وثائقية", "مجتاز", null, "محاضر الاجتماعات / سجل الحضور", null, null, null, null, null, "GOV-R-222", null, null],
  ["CMP-AUC-002", 12, "لجنة المراجعة", "التقارير", "رفع تقارير دورية لمجلس الإدارة", "Submit periodic reports to the board", "لائحة الحوكمة", "المادة 55", "نظام حوكمة الشركة - المادة 12", "POL-GOV-002", "هيئة السوق المالية (CMA)", "إلزامي", "أمانة المجلس", "رئيس لجنة المراجعة", null, "خط الدفاع الثالث", "ربع سنوي", null, null, null, 15, "حرج", 2, 4, null, null, "ضعف الرقابة / ملاحظة رقابية", "ملتزم", 1, "قالب تقرير موحد / جدول رفع التقارير", "مراجعة وثائقية", "مجتاز", null, "التقارير المرفوعة / محاضر المجلس", null, null, null, null, null, "GOV-R-756", null, null],
  ["CMP-AUC-003", 13, "لجنة المراجعة", "التقارير", "إعداد التقرير السنوي للجنة المراجعة قبل الجمعية بـ21 يوم", "Prepare annual audit committee report 21 days before GA", "لائحة الحوكمة", "المادة 56", "نظام حوكمة الشركة", "POL-GOV-002", "هيئة السوق المالية (CMA)", "إلزامي", "الالتزام والحوكمة", "رئيس لجنة المراجعة", "مدير الالتزام", "خط الدفاع الثالث", "سنوي", null, null, null, 30, "حرج", 2, 5, null, null, "غرامة / ملاحظة جوهرية", "ملتزم", 1, "خطة إعداد التقرير السنوي", "مراجعة وثائقية", "مجتاز", null, "التقرير السنوي للجنة / محضر الاعتماد", null, null, null, null, null, "GOV-R-756", null, null],
  ["CMP-AUC-004", 14, "لجنة المراجعة", "الرقابة المالية", "فحص القوائم المالية وإبداء الرأي حول كفاية الرقابة الداخلية", "Review financial statements and opine on internal controls adequacy", "لائحة الحوكمة", "المادة 54", "نظام حوكمة الشركة", "POL-GOV-002", "هيئة السوق المالية (CMA)", "إلزامي", "المراجعة الداخلية", "رئيس لجنة المراجعة", null, "خط الدفاع الثالث", "ربع سنوي", null, null, null, 15, "حرج", 2, 5, null, null, "رأي تدقيق سلبي / غرامات", "ملتزم", 1, "خطة مراجعة ربع سنوية", "فحص ميداني", "مجتاز", null, "تقارير فحص القوائم / محاضر اللجنة", null, null, null, null, null, "COM-R-755", null, null],
  ["CMP-AUC-005", 15, "لجنة المراجعة", "المراجع الخارجي", "الإشراف على المراجع الخارجي وتقييم استقلاليته", "Oversee external auditor and evaluate independence", "لائحة الحوكمة", "المادة 54", "نظام حوكمة الشركة", "POL-GOV-002", "هيئة السوق المالية (CMA)", "إلزامي", "المراجعة الداخلية", "رئيس لجنة المراجعة", null, "خط الدفاع الثالث", "سنوي", null, null, null, 30, "مرتفع", 2, 4, null, null, "ملاحظة رقابية", "ملتزم", 1, "تقييم سنوي للمراجع / اجتماعات دورية", "مراجعة وثائقية", "مجتاز", null, "تقرير تقييم المراجع / محضر التوصية", null, null, null, null, null, "GOV-R-222", null, null],
  ["CMP-NRC-001", 16, "لجنة الترشيحات والمكافآت", "المكافآت", "مراجعة سياسة المكافآت سنوياً والتوصية بتعديلها", "Annual review of remuneration policy and recommend amendments", "لائحة الحوكمة", "المادة 61", "سياسة المكافآت 2024", "POL-GOV-004", "هيئة السوق المالية (CMA)", "إلزامي", "الالتزام والحوكمة", "رئيس لجنة الترشيحات", null, "خط الدفاع الثاني", "سنوي", null, null, null, 60, "مرتفع", 2, 3, null, null, "ملاحظة في تقرير الحوكمة", "ملتزم", 1, "جدول مراجعة سنوي", "مراجعة وثائقية", "مجتاز", null, "محضر مراجعة السياسة / التوصيات", null, null, null, null, null, "GOV-R-757", null, null],
  ["CMP-NRC-002", 17, "لجنة الترشيحات والمكافآت", "الترشيحات", "ترشيح أعضاء المجلس وتقييم أدائهم", "Nominate board members and evaluate their performance", "لائحة الحوكمة", "المادة 65", "سياسة العضوية في المجلس 2024", "POL-GOV-005", "هيئة السوق المالية (CMA)", "إلزامي", "الالتزام والحوكمة", "رئيس لجنة الترشيحات", null, "خط الدفاع الثاني", "سنوي", null, null, null, 90, "مرتفع", 2, 4, null, null, "ضعف تشكيل المجلس", "ملتزم", 1, "معايير ترشيح واضحة / نماذج تقييم", "تقييم ذاتي", "مجتاز", null, "تقرير الترشيحات / نماذج التقييم", null, null, null, null, null, "GOV-R-242", null, null],
  ["CMP-RMC-001", 18, "لجنة إدارة المخاطر", "إدارة المخاطر", "تحديد المخاطر وتقييمها ووضع استراتيجيات التخفيف", "Identify, assess risks and develop mitigation strategies", "لائحة الحوكمة", "المادة 69", "نظام حوكمة الشركة", "POL-GOV-001", "هيئة السوق المالية (CMA)", "إلزامي", "الالتزام والحوكمة", "رئيس لجنة المخاطر", "مدير الالتزام", "خط الدفاع الثاني", "ربع سنوي", null, null, null, 30, "حرج", 2, 4, null, null, "ضعف إدارة المخاطر / ملاحظة رقابية", "ملتزم", 1, "سجل المخاطر / تقارير ربع سنوية", "فحص ميداني", "مجتاز", null, "سجل المخاطر المحدث / تقارير اللجنة", null, null, null, null, null, "COM-R-755", "KRI-RMC-01", null],
  ["CMP-RMC-002", 19, "لجنة إدارة المخاطر", "التقارير", "رفع تقارير المخاطر الدورية لمجلس الإدارة", "Submit periodic risk reports to the board", "لائحة الحوكمة", "المادة 69", "نظام حوكمة الشركة", "POL-GOV-001", "هيئة السوق المالية (CMA)", "إلزامي", "الالتزام والحوكمة", "رئيس لجنة المخاطر", null, "خط الدفاع الثاني", "ربع سنوي", null, null, null, 15, "حرج", 2, 4, null, null, "ضعف الإشراف على المخاطر", "ملتزم", 1, "قالب تقرير موحد", "مراجعة وثائقية", "مجتاز", null, "تقارير المخاطر الربع سنوية", null, null, null, null, null, "GOV-R-756", null, null],
  ["CMP-DIS-001", 20, "الإفصاح والشفافية", "القوائم المالية", "نشر القوائم المالية الربعية فور موافقة المجلس", "Publish quarterly financial statements upon board approval", "قواعد الطرح والالتزامات المستمرة", "المادة 43", "سياسة الإفصاح والشفافية", "POL-GOV-006", "هيئة السوق المالية (CMA)", "إلزامي", "الإدارة المالية", "المدير المالي", "المراقب المالي", "خط الدفاع الأول", "ربع سنوي", null, null, null, 15, "حرج", 2, 5, null, null, "وقف تداول / غرامة مالية كبيرة", "ملتزم", 1, "جدول إقفال مالي / تنسيق مع المراجع", "فحص ميداني", "مجتاز", null, "القوائم المنشورة / إشعار تداول", null, null, null, null, null, "GOV-R-230, GOV-R-239", "KRI-FIN-01", null],
  ["CMP-DIS-002", 21, "الإفصاح والشفافية", "القوائم المالية", "نشر القوائم المالية السنوية المراجعة فور موافقة المجلس", "Publish annual audited financial statements upon board approval", "قواعد الطرح والالتزامات المستمرة", "المادة 43", "سياسة الإفصاح والشفافية", "POL-GOV-006", "هيئة السوق المالية (CMA)", "إلزامي", "الإدارة المالية", "المدير المالي", null, "خط الدفاع الأول", "سنوي", null, null, null, 30, "حرج", 2, 5, null, null, "وقف تداول / غرامة / شطب محتمل", "ملتزم", 1, "خطة إقفال سنوي / جدول زمني مع المراجع", "فحص ميداني", "مجتاز", null, "القوائم السنوية المنشورة / تقرير المراجع", null, null, null, null, null, "GOV-R-230", "KRI-FIN-01", null],
  ["CMP-DIS-003", 22, "الإفصاح والشفافية", "التقارير", "نشر تقرير مجلس الإدارة السنوي الشامل", "Publish comprehensive annual board report", "قواعد الطرح / لائحة الحوكمة", "المادة 76", "سياسة الإفصاح والشفافية", "POL-GOV-006", "هيئة السوق المالية (CMA)", "إلزامي", "الالتزام والحوكمة", "مدير الالتزام", null, "خط الدفاع الثاني", "سنوي", null, null, null, 60, "حرج", 2, 5, null, null, "غرامة مالية / ملاحظة رقابية", "ملتزم", 1, "خطة إعداد التقرير / مراجعة متعددة", "مراجعة وثائقية", "مجتاز", null, "تقرير المجلس المنشور على تداول", null, null, null, null, null, "GOV-R-756", null, null],
  ["CMP-DIS-004", 23, "الإفصاح والشفافية", "الإفصاحات الجوهرية", "الإفصاح الفوري عن التطورات الجوهرية دون تأخير", "Immediate disclosure of material developments without delay", "قواعد الطرح", "المادة 40", "سياسة الإفصاح والشفافية", "POL-GOV-006", "هيئة السوق المالية (CMA)", "إلزامي", "الالتزام والحوكمة", "مدير الالتزام", null, "خط الدفاع الثاني", "فوري / عند الحدث", null, null, null, 1, "حرج", 3, 5, null, null, "غرامة كبيرة / وقف تداول / تحقيق رقابي", "ملتزم", 1, "إجراءات الإفصاح / تصعيد سريع / سياسة الأحداث الجوهرية", "مراجعة وثائقية", "مجتاز", null, "الإعلانات المنشورة / سجل الأحداث الجوهرية", null, null, null, null, null, "GOV-R-239", "KRI-GOV-04", null],
  ["CMP-DIS-005", 24, "الإفصاح والشفافية", "الإفصاحات الجوهرية", "الإفصاح عن صفقات أصول >= 10% من صافي الأصول", "Disclose asset transactions >= 10% of net assets", "قواعد الطرح", "المادة 41", "سياسة الإفصاح والشفافية", "POL-GOV-006", "هيئة السوق المالية (CMA)", "إلزامي", "الإدارة المالية", "المدير المالي", "مدير الالتزام", "خط الدفاع الأول", "فوري / عند الحدث", null, null, null, 1, "حرج", 1, 5, null, null, "غرامة / مساءلة المجلس", "ملتزم", 1, "مراقبة الصفقات الكبيرة / تنسيق مع القانونية", "فحص ميداني", "مجتاز", null, "إعلانات تداول / مستندات الصفقات", null, null, null, null, null, "GOV-R-239", null, null],
  ["CMP-DIS-006", 25, "الإفصاح والشفافية", "الإفصاحات الجوهرية", "الإفصاح عن خسائر >= 10% من صافي الأصول", "Disclose losses >= 10% of net assets", "قواعد الطرح", "المادة 42", "سياسة الإفصاح والشفافية", "POL-GOV-006", "هيئة السوق المالية (CMA)", "إلزامي", "الإدارة المالية", "المدير المالي", null, "خط الدفاع الأول", "فوري / عند الحدث", null, null, null, 1, "حرج", 2, 5, null, null, "غرامة كبيرة / وقف تداول", "ملتزم", 1, "مراقبة نسبة الخسائر شهرياً", "تحليل بيانات", "مجتاز", null, "إعلانات تداول / القوائم المالية", null, null, null, null, null, "GOV-R-230", null, null],
  ["CMP-COI-001", 30, "تعارض المصالح", "إفصاح المصالح", "إبلاغ المجلس بأي مصلحة مباشرة أو غير مباشرة في عقود الشركة", "Disclose any direct/indirect interest in company contracts to the board", "نظام الشركات", "المادة 71", "سياسة تعارض المصالح - البند خامساً", "POL-GOV-003", "وزارة التجارة", "إلزامي", "أمانة المجلس", "العضو المعني", "أمين سر المجلس", "خط الدفاع الأول", "فوري / عند الحدث", null, null, null, 1, "حرج", 2, 5, null, null, "بطلان العقد / مسؤولية شخصية / غرامة", "ملتزم", 1, "سجل الأطراف ذوي العلاقة / نماذج إفصاح", "مراجعة وثائقية", "مجتاز", null, "نماذج الإفصاح / محاضر المجلس", null, null, null, null, null, "GOV-R-241, GOV-R-236", null, null],
  ["CMP-COI-002", 31, "تعارض المصالح", "التصويت", "عدم اشتراك العضو صاحب المصلحة في التصويت", "Member with interest shall not vote on related decisions", "نظام الشركات", "المادة 71", "سياسة تعارض المصالح", "POL-GOV-003", "وزارة التجارة", "إلزامي", "أمانة المجلس", "أمين سر المجلس", null, "خط الدفاع الأول", "فوري / عند الحدث", null, null, null, 0, "حرج", 1, 5, null, null, "بطلان القرار / مسؤولية قانونية", "ملتزم", 1, "التحقق قبل التصويت / توثيق في المحضر", "مراجعة وثائقية", "مجتاز", null, "محاضر الاجتماعات / سجل التصويت", null, null, null, null, null, "GOV-R-241", null, null],
  ["CMP-COI-003", 34, "تعارض المصالح", "حظر التداول الداخلي", "حظر التداول بناء على معلومات داخلية", "Prohibition of insider trading", "نظام السوق المالية / لائحة سلوك السوق", "المادة 50", "سياسة تعارض المصالح - المحظورات", "POL-GOV-003", "هيئة السوق المالية (CMA)", "إلزامي", "الالتزام والحوكمة", "مدير الالتزام", null, "خط الدفاع الثاني", "مستمر", null, null, null, 0, "حرج", 2, 5, null, null, "سجن / غرامة تصل 5 مليون ريال / حظر تداول", "ملتزم", 1, "تنبيهات فترات الحظر / سجل المطلعين", "مراجعة وثائقية", "مجتاز", null, "سجل المطلعين / إشعارات الحظر", null, null, null, null, null, "GOV-R-758", null, null],
  ["CMP-ICO-001", 38, "الرقابة الداخلية", "نظام الرقابة", "اعتماد نظام رقابة داخلية شامل لتقييم السياسات وإدارة المخاطر", "Adopt comprehensive internal control system", "لائحة الحوكمة", "المادة 69", "نظام حوكمة الشركة - المادة 4", "POL-GOV-001", "هيئة السوق المالية (CMA)", "إلزامي", "المراجعة الداخلية", "مدير المراجعة الداخلية", null, "خط الدفاع الثالث", "سنوي", null, null, null, 60, "حرج", 3, 5, null, null, "ملاحظة جوهرية من المراجع / غرامة", "ملتزم جزئياً", 0.7, "إطار رقابة داخلية / تقييم سنوي", "فحص ميداني", "جزئي", null, "تقرير الرقابة الداخلية / تقييم الفعالية", "بعض الضوابط الرقابية بحاجة لتحديث", "تحديث إطار الرقابة الداخلية", "2026-06-30", "مدير المراجعة الداخلية", "قيد التنفيذ", "COM-R-755, COM-R-228", "KRI-IA-01", null],
  ["CMP-ICO-002", 39, "الرقابة الداخلية", "خطة المراجعة", "إعداد خطة مراجعة داخلية سنوية معتمدة من لجنة المراجعة", "Prepare annual internal audit plan approved by audit committee", "لائحة الحوكمة", "المادة 73", "نظام حوكمة الشركة", "POL-GOV-002", "هيئة السوق المالية (CMA)", "إلزامي", "المراجعة الداخلية", "مدير المراجعة الداخلية", null, "خط الدفاع الثالث", "سنوي", null, null, null, 30, "حرج", 2, 4, null, null, "ضعف الرقابة / ملاحظة رقابية", "ملتزم", 1, "خطة سنوية مبنية على المخاطر", "مراجعة وثائقية", "مجتاز", null, "خطة المراجعة المعتمدة / محضر لجنة المراجعة", null, null, null, null, null, "COM-R-755", null, null],
  ["CMP-ITR-001", 45, "حظر التداول", "فترات الحظر", "حظر التداول 15 يوماً قبل نهاية ربع السنة المالية حتى الإفصاح", "Trading blackout 15 days before quarter-end until disclosure", "لائحة سلوك السوق", "المادة 10", "سياسة تعارض المصالح", "POL-GOV-003", "هيئة السوق المالية (CMA)", "إلزامي", "الالتزام والحوكمة", "مدير الالتزام", null, "خط الدفاع الثاني", "ربع سنوي", null, null, null, 20, "حرج", 2, 5, null, null, "غرامة / سجن / حظر تداول شخصي", "ملتزم", 1, "تنبيهات تلقائية / قائمة المطلعين", "مراجعة وثائقية", "مجتاز", null, "إشعارات الحظر / سجل التداولات", null, null, null, null, null, "GOV-R-758", "KRI-GOV-05", null],
  ["CMP-ITR-002", 46, "حظر التداول", "فترات الحظر", "حظر التداول 30 يوماً قبل نهاية السنة المالية حتى الإفصاح", "Trading blackout 30 days before year-end until disclosure", "لائحة سلوك السوق", "المادة 10", "سياسة تعارض المصالح", "POL-GOV-003", "هيئة السوق المالية (CMA)", "إلزامي", "الالتزام والحوكمة", "مدير الالتزام", null, "خط الدفاع الثاني", "سنوي", null, null, null, 35, "حرج", 2, 5, null, null, "غرامة / سجن / حظر تداول", "ملتزم", 1, "تنبيهات تلقائية / متابعة دورية", "مراجعة وثائقية", "مجتاز", null, "إشعارات الحظر السنوية", null, null, null, null, null, "GOV-R-758", null, null],
  ["CMP-ITR-003", 47, "حظر التداول", "التنبيهات", "إرسال تنبيهات قبل بداية فترات الحظر", "Send alerts before blackout periods start", "لائحة سلوك السوق", "المادة 10", "سياسة تعارض المصالح", "POL-GOV-003", "هيئة السوق المالية (CMA)", "إلزامي", "الالتزام والحوكمة", "مدير الالتزام", null, "خط الدفاع الثاني", "ربع سنوي", null, null, null, 5, "مرتفع", 2, 4, null, null, "مسؤولية على الشركة", "ملتزم", 1, "نظام تنبيهات آلي / قائمة توزيع", "مراجعة وثائقية", "مجتاز", null, "نسخ من التنبيهات المرسلة", null, null, null, null, null, "GOV-R-758", null, null],
  ["CMP-WBI-001", 49, "الإبلاغ عن المخالفات", "قنوات الإبلاغ", "فتح قنوات إبلاغ لأصحاب المصالح", "Establish whistleblowing channels for stakeholders", "لائحة الحوكمة", "المادة 84", "سياسة الإبلاغ عن المخالفات", "POL-GOV-007", "هيئة السوق المالية (CMA)", "إلزامي", "الالتزام والحوكمة", "مدير الالتزام", null, "خط الدفاع الثاني", "مستمر", null, null, null, 0, "حرج", 2, 4, null, null, "غرامة / ملاحظة رقابية", "ملتزم", 1, "قنوات متعددة (هاتف/بريد/نظام)", "فحص ميداني", "مجتاز", null, "قائمة القنوات المتاحة / تقارير البلاغات", null, null, null, null, null, "GOV-R-754", null, null],
  ["CMP-WBI-002", 50, "الإبلاغ عن المخالفات", "الموظف المختص", "تعيين موظف مختص لتلقي الشكاوى والبلاغات", "Appoint dedicated officer to receive complaints", "لائحة الحوكمة", "المادة 84", "سياسة الإبلاغ عن المخالفات", "POL-GOV-007", "هيئة السوق المالية (CMA)", "إلزامي", "الإدارة التنفيذية", "الرئيس التنفيذي", null, "خط الدفاع الثاني", "مستمر", null, null, null, 0, "مرتفع", 2, 3, null, null, "ملاحظة رقابية", "ملتزم", 1, "تعيين رسمي / صلاحيات واضحة", "مراجعة وثائقية", "مجتاز", null, "خطاب التعيين / التوصيف الوظيفي", null, null, null, null, null, "GOV-R-754", null, null],
  ["CMP-SHR-001", 54, "حقوق المساهمين", "الجمعية العامة", "عقد الجمعية العامة السنوية للمساهمين", "Hold annual general assembly meeting", "نظام الشركات", "المادة 91", "سياسة شؤون المساهمين", "POL-GOV-008", "وزارة التجارة", "إلزامي", "شؤون المساهمين", "أمين سر المجلس", "مدير الالتزام", "خط الدفاع الأول", "سنوي", null, null, null, 60, "حرج", 1, 5, null, null, "غرامة / مساءلة المجلس", "ملتزم", 1, "تخطيط مبكر / تنسيق مع تداول", "فحص ميداني", "مجتاز", null, "محضر الجمعية / إعلان تداول", null, null, null, null, null, "GOV-R-234", null, null],
  ["CMP-SHR-002", 55, "حقوق المساهمين", "الجمعية العامة", "الدعوة للجمعية العامة قبل 21 يوماً ونشرها", "Invite to GA at least 21 days in advance and publish", "نظام الشركات", "المادة 91", "سياسة شؤون المساهمين", "POL-GOV-008", "وزارة التجارة", "إلزامي", "شؤون المساهمين", "أمين سر المجلس", null, "خط الدفاع الأول", "سنوي", null, null, null, 25, "حرج", 1, 5, null, null, "بطلان الجمعية / مساءلة قانونية", "ملتزم", 1, "جدول زمني محدد / نشر على تداول", "مراجعة وثائقية", "مجتاز", null, "إعلان الدعوة / النشر في الصحيفة", null, null, null, null, null, "GOV-R-234", null, null],
  ["CMP-CMP-001", 58, "المكافآت والتعويضات", "الإفصاح", "الإفصاح عن سياسة المكافآت في تقرير المجلس", "Disclose remuneration policy in board report", "لائحة الحوكمة", "المادة 90", "سياسة المكافآت 2024", "POL-GOV-004", "هيئة السوق المالية (CMA)", "إلزامي", "الالتزام والحوكمة", "مدير الالتزام", null, "خط الدفاع الثاني", "سنوي", null, null, null, 30, "مرتفع", 2, 4, null, null, "ملاحظة في تقرير الحوكمة", "ملتزم", 1, "قالب الإفصاح / مراجعة سنوية", "مراجعة وثائقية", "مجتاز", null, "تقرير المجلس - قسم المكافآت", null, null, null, null, null, "GOV-R-236", null, null],
  ["CMP-TAX-001", 81, "الالتزامات الضريبية والزكوية", "الإقرارات الزكوية", "تقديم الإقرار الزكوي السنوي وسداد الزكاة المستحقة", "Submit annual zakat return and pay due zakat", "نظام جباية الزكاة", "المادة 14", "سياسة الضرائب", "POL-FIN-005", "هيئة الزكاة والضريبة والجمارك (ZATCA)", "إلزامي", "الإدارة المالية", "مدير الضرائب", "المراقب المالي", "خط الدفاع الأول", "سنوي", null, null, null, 30, "حرج", 2, 5, null, null, "غرامة 1% عن كل 30 يوم تأخير / حجز حسابات", "ملتزم", 1, "جدول إقرارات / مراجعة من المحاسب القانوني", "فحص ميداني", "مجتاز", null, "الإقرار المقدم / إشعار السداد / شهادة الزكاة", null, null, null, null, null, "FIN-001", "KRI-FIN-03", null],
  ["CMP-TAX-002", 82, "الالتزامات الضريبية والزكوية", "ضريبة الاستقطاع", "استقطاع الضريبة من المدفوعات للجهات غير المقيمة وتوريدها", "Withhold tax on payments to non-residents and remit to ZATCA", "نظام ضريبة الدخل", "المادة 68", "سياسة الضرائب", "POL-FIN-005", "هيئة الزكاة والضريبة والجمارك (ZATCA)", "إلزامي", "الإدارة المالية", "مدير الضرائب", null, "خط الدفاع الأول", "شهري", null, null, null, 10, "حرج", 2, 5, null, null, "غرامة 1% عن كل 30 يوم + ضريبة إضافية", "ملتزم", 1, "مراجعة العقود الأجنبية / نظام محاسبي", "فحص ميداني", "مجتاز", null, "نماذج الاستقطاع / إشعارات السداد", null, null, null, null, null, "FIN-001", null, null],
  ["CMP-VAT-001", 83, "ضريبة القيمة المضافة", "الإقرارات", "تقديم إقرار ضريبة القيمة المضافة الشهري", "Submit monthly VAT return by last day of following month", "نظام ضريبة القيمة المضافة", "المادة 60", "سياسة الضرائب", "POL-FIN-005", "هيئة الزكاة والضريبة والجمارك (ZATCA)", "إلزامي", "الإدارة المالية", "مدير الضرائب", "المراقب المالي", "خط الدفاع الأول", "شهري", null, null, null, 10, "حرج", 2, 5, null, null, "غرامة 5%-25% من الضريبة غير المسددة", "ملتزم", 1, "جدول إقرارات شهري / نظام تنبيهات", "فحص ميداني", "مجتاز", null, "الإقرار المقدم / إشعار السداد", null, null, null, null, null, "FIN-001", "KRI-FIN-03", null],
  ["CMP-VAT-002", 84, "ضريبة القيمة المضافة", "الفوترة الإلكترونية", "الالتزام بنظام الفوترة الإلكترونية (فاتورة) المرحلة الثانية", "Comply with e-invoicing system (FATOORAH) Phase 2", "قرارات ZATCA", "قرار 2023", "سياسة الضرائب", "POL-FIN-005", "هيئة الزكاة والضريبة والجمارك (ZATCA)", "إلزامي", "تقنية المعلومات", "مدير تقنية المعلومات", "مدير الضرائب", "خط الدفاع الأول", "مستمر", null, null, null, 0, "حرج", 2, 5, null, null, "غرامة تصل 50,000 ريال لكل فاتورة مخالفة", "ملتزم", 1, "نظام فوترة متوافق / اختبارات دورية", "اختبار تشغيلي", "مجتاز", null, "تقرير توافق النظام / شهادة الربط مع ZATCA", null, null, null, null, null, "FIN-001", null, null],
  ["CMP-LAB-001", 85, "نظام العمل", "عقود العمل", "توثيق عقود العمل كتابياً وتسجيلها في منصة قوى", "Document employment contracts in writing and register on Qiwa", "نظام العمل", "المادة 51", "سياسة الموارد البشرية", "POL-HR-001", "وزارة الموارد البشرية والتنمية الاجتماعية", "إلزامي", "الموارد البشرية", "مدير الموارد البشرية", "أخصائي شؤون الموظفين", "خط الدفاع الأول", "مستمر", null, null, null, 0, "حرج", 2, 4, null, null, "غرامة 5,000-20,000 ريال لكل عقد / إيقاف خدمات", "ملتزم", 1, "نظام HR إلكتروني / مراجعة دورية للعقود", "فحص ميداني", "مجتاز", null, "نسخ العقود الموقعة / تقرير منصة قوى", null, null, null, null, null, "HR-001", null, null],
  ["CMP-LAB-002", 86, "نظام العمل", "ساعات العمل", "الالتزام بساعات العمل القصوى (8 ساعات/يوم أو 48 ساعة/أسبوع)", "Comply with maximum working hours (8hrs/day or 48hrs/week)", "نظام العمل", "المادة 98", "سياسة الموارد البشرية", "POL-HR-001", "وزارة الموارد البشرية والتنمية الاجتماعية", "إلزامي", "الموارد البشرية", "مدير الموارد البشرية", null, "خط الدفاع الأول", "مستمر", null, null, null, 0, "مرتفع", 2, 3, null, null, "غرامة 3,000-10,000 ريال / شكاوى عمالية", "ملتزم", 1, "نظام حضور وانصراف إلكتروني", "فحص ميداني", "مجتاز", null, "تقارير الحضور / سجل الساعات الإضافية", null, null, null, null, null, "HR-003", null, null],
  ["CMP-LAB-003", 87, "نظام العمل", "الإجازات", "منح الإجازة السنوية (21 يوم، و30 يوم بعد 5 سنوات)", "Grant annual leave (21 days, 30 after 5 years)", "نظام العمل", "المادة 109", "سياسة الموارد البشرية", "POL-HR-001", "وزارة الموارد البشرية والتنمية الاجتماعية", "إلزامي", "الموارد البشرية", "مدير الموارد البشرية", null, "خط الدفاع الأول", "سنوي", null, null, null, 30, "مرتفع", 2, 3, null, null, "غرامة / شكاوى عمالية / تعويض مالي", "ملتزم", 1, "نظام إدارة الإجازات / متابعة الأرصدة", "تحليل بيانات", "مجتاز", null, "تقارير أرصدة الإجازات / سجل الإجازات", null, null, null, null, null, "HR-003", null, null],
  ["CMP-LAB-004", 88, "نظام العمل", "نهاية الخدمة", "صرف مكافأة نهاية الخدمة حسب النظام", "Pay end-of-service benefits per labor law", "نظام العمل", "المادة 84", "سياسة الموارد البشرية", "POL-HR-001", "وزارة الموارد البشرية والتنمية الاجتماعية", "إلزامي", "الموارد البشرية", "مدير الموارد البشرية", "المدير المالي", "خط الدفاع الأول", "فوري / عند الحدث", null, null, null, 7, "حرج", 2, 4, null, null, "شكوى عمالية / حكم قضائي بالتعويض", "ملتزم", 1, "حساب آلي في نظام الرواتب / مراجعة قانونية", "تحليل بيانات", "مجتاز", null, "كشوفات المخالصات / إخلاء الطرف", null, null, null, null, null, "HR-003", null, null],
  ["CMP-LAB-005", 89, "نظام العمل", "حماية الأجور", "تحويل الرواتب عبر النظام المصرفي (حماية الأجور)", "Transfer salaries through banking system (WPS)", "نظام العمل", "قرارات وزارية", "سياسة الموارد البشرية", "POL-HR-001", "وزارة الموارد البشرية والتنمية الاجتماعية", "إلزامي", "الإدارة المالية", "مشرف الرواتب", "المدير المالي", "خط الدفاع الأول", "شهري", null, null, null, 5, "حرج", 3, 5, null, null, "إيقاف الخدمات / حظر الاستقدام / غرامة", "ملتزم جزئياً", 0.8, "نظام حماية الأجور / تحويل بنكي شهري", "تحليل بيانات", "جزئي", null, "تقارير حماية الأجور / كشوف البنك", "تأخر في تحويل رواتب بعض الأشهر", "تحسين إدارة التدفقات النقدية", "2026-06-30", "المدير المالي", "قيد التنفيذ", "HR-003, FIN-003", "KRI-HR-01", null],
  ["CMP-SAU-001", 90, "السعودة ونطاقات", "نسبة التوطين", "تحقيق نسبة التوطين المطلوبة وفق برنامج نطاقات", "Achieve required Saudization ratio per Nitaqat", "نظام العمل", "المادة 26", "سياسة التوطين", "POL-HR-002", "وزارة الموارد البشرية والتنمية الاجتماعية", "إلزامي", "الموارد البشرية", "مدير الموارد البشرية", "أخصائي التوطين", "خط الدفاع الأول", "ربع سنوي", null, null, null, 30, "حرج", 3, 5, null, null, "حظر تأشيرات / حظر نقل كفالات / غرامة", "ملتزم جزئياً", 0.75, "تقرير نطاقات شهري / خطة توطين سنوية", "فحص ميداني", "جزئي", null, "تقرير نطاقات / خطة التوطين المعتمدة", "النسبة الحالية أقل من المطلوب بـ3%", "توظيف 8 سعوديين خلال Q1-Q2 2026", "2026-06-30", "مدير التوظيف", "قيد التنفيذ", "HR-001", "KRI-HR-02", null],
  ["CMP-GOSI-001", 91, "التأمينات الاجتماعية", "الاشتراكات", "تسجيل جميع الموظفين في GOSI وسداد الاشتراكات الشهرية", "Register all employees in GOSI and pay monthly contributions", "نظام التأمينات الاجتماعية", "المادة 18-19", "سياسة الموارد البشرية", "POL-HR-001", "المؤسسة العامة للتأمينات الاجتماعية", "إلزامي", "الموارد البشرية", "مشرف الرواتب", "مدير الموارد البشرية", "خط الدفاع الأول", "شهري", null, null, null, 10, "حرج", 1, 4, null, null, "غرامة 2% عن كل شهر تأخير / حجز حسابات", "ملتزم", 1, "نظام رواتب مربوط بـ GOSI / مراجعة شهرية", "تحليل بيانات", "مجتاز", null, "تقارير السداد الشهرية / شهادة التأمينات", null, null, null, null, null, "HR-003, FIN-001", "KRI-HR-03", null],
  ["CMP-GOSI-002", 92, "التأمينات الاجتماعية", "إصابات العمل", "الإبلاغ عن إصابات العمل خلال 3 أيام", "Report work injuries within 3 days", "نظام التأمينات الاجتماعية", "المادة 28", "سياسة السلامة", "POL-HSE-001", "المؤسسة العامة للتأمينات الاجتماعية", "إلزامي", "إدارة السلامة", "مدير السلامة", "مدير الموارد البشرية", "خط الدفاع الأول", "فوري / عند الحدث", null, null, null, 1, "حرج", 2, 4, null, null, "رفض المطالبة / غرامة / مسؤولية قانونية", "ملتزم", 1, "إجراء إبلاغ واضح / نموذج إبلاغ جاهز", "فحص ميداني", "مجتاز", null, "نماذج الإبلاغ / تقارير الإصابات", null, null, null, null, null, "HR-003", null, null],
  ["CMP-HSE-001", 93, "السلامة والصحة المهنية", "تصاريح الدفاع المدني", "الحصول على تصريح الدفاع المدني وتجديده سنوياً", "Obtain and renew civil defense permit annually", "نظام الدفاع المدني", "المادة 15", "سياسة السلامة", "POL-HSE-001", "الدفاع المدني", "إلزامي", "إدارة السلامة", "مدير السلامة", null, "خط الدفاع الأول", "سنوي", null, null, null, 60, "حرج", 2, 5, null, null, "إغلاق المنشأة / غرامة / مسؤولية جنائية", "ملتزم", 1, "تقويم تجديد التراخيص / فحص دوري", "فحص ميداني", "مجتاز", null, "شهادة الدفاع المدني / تقرير الفحص", null, null, null, null, null, "OPR-001", null, null],
  ["CMP-HSE-002", 94, "السلامة والصحة المهنية", "معدات السلامة", "توفير معدات الوقاية الشخصية (PPE) لجميع العاملين", "Provide PPE to all workers", "نظام العمل", "المادة 121-122", "سياسة السلامة", "POL-HSE-001", "وزارة الموارد البشرية والتنمية الاجتماعية", "إلزامي", "إدارة السلامة", "مدير السلامة", "مدير العمليات", "خط الدفاع الأول", "مستمر", null, null, null, 0, "حرج", 2, 4, null, null, "غرامة 10,000-25,000 ريال / إيقاف العمل", "ملتزم", 1, "سجل توزيع PPE / فحصات دورية", "فحص ميداني", "مجتاز", null, "سجل استلام المعدات / تقارير الفحص", null, null, null, null, null, "OPR-002", null, null],
  ["CMP-HSE-003", 95, "السلامة والصحة المهنية", "الفحوصات الطبية", "إجراء فحوصات طبية دورية للعاملين في البيئات الخطرة", "Conduct periodic medical examinations for hazardous environment workers", "نظام العمل", "المادة 142", "سياسة السلامة", "POL-HSE-001", "وزارة الموارد البشرية والتنمية الاجتماعية", "إلزامي", "الموارد البشرية", "مدير السلامة", "مدير الموارد البشرية", "خط الدفاع الأول", "سنوي", null, null, null, 60, "مرتفع", 3, 4, null, null, "غرامة / مسؤولية عن إصابات مهنية", "ملتزم جزئياً", 0.7, "برنامج فحوصات سنوي", "فحص ميداني", "جزئي", null, "تقارير الفحوصات الطبية", "بعض العاملين لم يُفحصوا خلال السنة", "جدولة الفحوصات المتبقية", "2026-04-30", "مدير السلامة", "قيد التنفيذ", "HR-003", null, null],
  ["CMP-ENV-001", 96, "البيئة", "التصريح البيئي", "الحصول على التصريح البيئي من NCEC وتجديده", "Obtain and renew environmental permit from NCEC", "نظام البيئة", "المادة 10", "سياسة البيئة", "POL-HSE-002", "المركز الوطني للرقابة على الالتزام البيئي", "إلزامي", "إدارة السلامة", "مدير السلامة", "مدير العمليات", "خط الدفاع الأول", "سنوي", null, null, null, 90, "حرج", 2, 5, null, null, "إيقاف النشاط / غرامة تصل 10 مليون ريال", "ملتزم", 1, "تقويم تجديد / مراقبة الانبعاثات", "فحص ميداني", "مجتاز", null, "التصريح البيئي / تقارير المراقبة", null, null, null, null, null, "OPR-001", null, null],
  ["CMP-ENV-002", 97, "البيئة", "إدارة النفايات", "التخلص الآمن من النفايات الصناعية وفق الاشتراطات البيئية", "Safe disposal of industrial waste per environmental requirements", "نظام البيئة", "المادة 17", "سياسة البيئة", "POL-HSE-002", "المركز الوطني للرقابة على الالتزام البيئي", "إلزامي", "العمليات / الإنتاج", "مدير العمليات", "مدير السلامة", "خط الدفاع الأول", "مستمر", null, null, null, 0, "مرتفع", 3, 4, null, null, "غرامة / إيقاف / مسؤولية بيئية", "ملتزم", 1, "عقود مع شركات نفايات مرخصة / سجل النفايات", "فحص ميداني", "مجتاز", null, "عقود التخلص / سجل النفايات / بوالص الشحن", null, null, null, null, null, "OPR-001", null, null],
  ["CMP-IND-001", 98, "الترخيص الصناعي", "الترخيص", "تجديد الترخيص الصناعي سنوياً", "Renew industrial license annually", "نظام الاستثمار التعديني", "المادة 5", null, null, "وزارة الصناعة والثروة المعدنية", "إلزامي", "الإدارة التنفيذية", "الرئيس التنفيذي", "مدير العمليات", "خط الدفاع الأول", "سنوي", null, null, null, 90, "حرج", 1, 5, null, null, "إيقاف النشاط الصناعي / غرامة", "ملتزم", 1, "تقويم تجديد / متابعة الاشتراطات", "مراجعة وثائقية", "مجتاز", null, "الترخيص الصناعي الساري / إشعار التجديد", null, null, null, null, null, "OPR-001", null, null],
  ["CMP-SASO-001", 99, "المواصفات والمقاييس", "مواصفات الكابلات", "الامتثال لمواصفات SASO للكابلات الكهربائية", "Comply with SASO standards for electrical cables (IEC 60502)", "اللائحة الفنية للكابلات", "SASO IEC 60502", "سياسة الجودة", "POL-QA-001", "الهيئة السعودية للمواصفات والمقاييس (SASO)", "إلزامي", "ضمان الجودة", "مدير الجودة", "مدير العمليات", "خط الدفاع الأول", "مستمر", null, null, null, 0, "حرج", 2, 5, null, null, "سحب المنتج / غرامة / إيقاف الإنتاج", "ملتزم", 1, "اختبارات جودة دورية / مختبر معتمد", "اختبار تشغيلي", "مجتاز", null, "شهادات الاختبار / تقارير المختبر / علامة الجودة", null, null, null, null, null, "OPR-001", "KRI-QA-01", null],
  ["CMP-SASO-002", 100, "المواصفات والمقاييس", "شهادة المطابقة", "الحصول على شهادة مطابقة SASO لكل منتج", "Obtain SASO conformity certificate for each product", "نظام المواصفات والمقاييس", "المادة 10", "سياسة الجودة", "POL-QA-001", "الهيئة السعودية للمواصفات والمقاييس (SASO)", "إلزامي", "ضمان الجودة", "مدير الجودة", null, "خط الدفاع الأول", "سنوي", null, null, null, 90, "حرج", 2, 5, null, null, "حظر بيع المنتج / سحب من السوق", "ملتزم", 1, "جدول تجديد الشهادات / اختبارات المطابقة", "اختبار تشغيلي", "مجتاز", null, "شهادات المطابقة / تقارير الاختبار", null, null, null, null, null, "OPR-001", null, null],
  ["CMP-DATA-001", 101, "حماية البيانات والخصوصية", "معالجة البيانات", "الحصول على موافقة صاحب البيانات قبل جمع ومعالجة بياناته الشخصية", "Obtain data subject consent before collecting/processing personal data", "نظام حماية البيانات الشخصية", "المادة 6", "سياسة حماية البيانات", "POL-IT-001", "الهيئة السعودية للبيانات والذكاء الاصطناعي", "إلزامي", "تقنية المعلومات", "مدير تقنية المعلومات", "مسؤول حماية البيانات", "خط الدفاع الأول", "مستمر", null, null, null, 0, "مرتفع", 3, 4, null, null, "غرامة تصل 5 مليون ريال / سجن", "غير مُقيَّم", 0, null, null, "لم يُختبر", null, null, "يحتاج تقييم شامل لممارسات حماية البيانات", "إجراء تقييم أثر حماية البيانات (DPIA)", "2026-09-30", "مسؤول حماية البيانات", "لم تبدأ", "GOV-R-749", null, "مجال جديد يحتاج اهتماماً عاجلاً"],
  ["CMP-CYB-001", 102, "الأمن السيبراني", "الضوابط الأساسية", "الامتثال للضوابط الأساسية للأمن السيبراني (ECC)", "Comply with Essential Cybersecurity Controls (ECC)", "ضوابط الأمن السيبراني", "ECC-1:2018", "سياسة الأمن السيبراني", "POL-IT-002", "الهيئة الوطنية للأمن السيبراني", "إلزامي", "تقنية المعلومات", "مدير تقنية المعلومات", "مسؤول أمن المعلومات", "خط الدفاع الأول", "سنوي", null, null, null, 90, "حرج", 3, 5, null, null, "غرامة / إيقاف أنظمة / مسؤولية جنائية", "غير مُقيَّم", 0, null, null, "لم يُختبر", null, null, "يحتاج تقييم شامل للامتثال لضوابط ECC", "إجراء تقييم امتثال الأمن السيبراني", "2026-09-30", "مدير تقنية المعلومات", "لم تبدأ", "GOV-R-749", null, "مجال جديد يحتاج اهتماماً عاجلاً"],
  ["CMP-FRP-001", 103, "التنظيم المالي", "إجراءات التنظيم", "الالتزام بشروط وأحكام خطة إعادة التنظيم المالي المعتمدة", "Comply with approved financial restructuring plan terms", "نظام الإفلاس", "المادة 100-120", "خطة إعادة التنظيم المالي", "POL-FIN-010", "لجنة التنظيم المالي", "إلزامي", "الإدارة المالية", "المدير المالي", "الرئيس التنفيذي", "خط الدفاع الأول", "ربع سنوي", null, null, null, 15, "حرج", 3, 5, null, null, "تصفية الشركة / غرامات / مسؤولية جنائية", "ملتزم جزئياً", 0.8, "تقارير دورية للجنة / متابعة الالتزامات", "فحص ميداني", "جزئي", null, "تقارير الالتزام / محاضر لجنة التنظيم", "بعض الشروط بحاجة لمتابعة أكبر", "تكثيف المتابعة الدورية", "2026-06-30", "المدير المالي", "قيد التنفيذ", "FIN-001, FIN-003", "KRI-FIN-05", null],
  ["CMP-FRP-002", 104, "التنظيم المالي", "التقارير", "تقديم تقارير دورية عن سير خطة إعادة التنظيم للمحكمة التجارية", "Submit periodic progress reports to commercial court", "نظام الإفلاس", "المادة 115", "خطة إعادة التنظيم المالي", "POL-FIN-010", "لجنة التنظيم المالي", "إلزامي", "الإدارة المالية", "المدير المالي", null, "خط الدفاع الأول", "ربع سنوي", null, null, null, 15, "حرج", 2, 5, null, null, "إنهاء إجراء التنظيم / تصفية", "ملتزم", 1, "جدول تقارير / تنسيق مع المستشار القانوني", "مراجعة وثائقية", "مجتاز", null, "التقارير المقدمة / إشعارات الاستلام", null, null, null, null, null, "FIN-001", null, null],
  ["CMP-CR-001", 105, "السجل التجاري والتراخيص البلدية", "السجل التجاري", "تجديد السجل التجاري قبل انتهائه", "Renew commercial registration before expiry", "نظام السجل التجاري", "المادة 7", null, null, "وزارة التجارة", "إلزامي", "القانونية", "المستشار القانوني", "مدير الالتزام", "خط الدفاع الأول", "سنوي", null, null, null, 90, "حرج", 1, 5, null, null, "إيقاف النشاط التجاري / غرامة", "ملتزم", 1, "تقويم تجديد التراخيص", "مراجعة وثائقية", "مجتاز", null, "السجل التجاري الساري", null, null, null, null, null, "OPR-001", null, null],
  ["CMP-CR-002", 106, "السجل التجاري والتراخيص البلدية", "الرخصة البلدية", "تجديد الرخصة البلدية للمنشأة", "Renew municipal license for the facility", "نظام البلديات", null, null, null, "أمانة جدة", "إلزامي", "القانونية", "المستشار القانوني", null, "خط الدفاع الأول", "سنوي", null, null, null, 90, "مرتفع", 1, 4, null, null, "إغلاق المنشأة / غرامة", "ملتزم", 1, "تقويم تجديد", "مراجعة وثائقية", "مجتاز", null, "الرخصة البلدية السارية", null, null, null, null, null, "OPR-001", null, null],
  ["CMP-AML-001", 107, "مكافحة غسل الأموال", "سياسات AML", "تطبيق سياسة مكافحة غسل الأموال وتمويل الإرهاب", "Implement AML/CFT policy", "نظام مكافحة غسل الأموال", "المادة 5", "سياسة مكافحة غسل الأموال", "POL-COMP-001", "هيئة السوق المالية (CMA)", "إلزامي", "الالتزام والحوكمة", "مدير الالتزام", null, "خط الدفاع الثاني", "مستمر", null, null, null, 0, "مرتفع", 2, 4, null, null, "غرامة / عقوبات جنائية", "ملتزم", 1, "سياسة معتمدة / تدريب دوري / فحص العملاء", "مراجعة وثائقية", "مجتاز", null, "السياسة المعتمدة / سجلات التدريب / تقارير KYC", null, null, null, null, null, "COM-R-755", null, null],
  ["CMP-COM-001", 108, "المنافسة", "الممارسات المنافسة", "الالتزام بضوابط ومعايير المنافسة العادلة", "Comply with fair competition standards", "نظام المنافسة", "المادة 4", "سياسة المنافسة", "POL-COMP-002", "الهيئة العامة للمنافسة", "إلزامي", "القانونية", "المستشار القانوني", "مدير الالتزام", "خط الدفاع الأول", "مستمر", null, null, null, 0, "مرتفع", 2, 4, null, null, "غرامة تصل 10% من الإيرادات / سجن", "ملتزم", 1, "مراجعة العقود / تدريب على قواعد المنافسة", "مراجعة وثائقية", "مجتاز", null, "سجل التدريبات / مراجعات العقود", null, null, null, null, null, "COM-R-755", null, null],
  ["CMP-DOC-001", 109, "حفظ الوثائق", "محاضر المجلس", "حفظ محاضر المجلس واللجان لمدة لا تقل عن 10 سنوات", "Retain board and committee minutes for at least 10 years", "نظام الشركات", "المادة 97", "نظام حوكمة الشركة", "POL-GOV-001", "وزارة التجارة", "إلزامي", "أمانة المجلس", "أمين سر المجلس", null, "خط الدفاع الأول", "مستمر", null, null, null, 0, "مرتفع", 2, 4, null, null, "فقدان أدلة / مساءلة قانونية", "ملتزم", 1, "نظام أرشفة إلكتروني / حفظ ورقي مؤمن", "مراجعة وثائقية", "مجتاز", null, "سجل الأرشفة / فهرس الوثائق", null, null, null, null, null, "GOV-R-224", null, null],
  ["CMP-EXA-001", 110, "المراجع الخارجي", "التعيين", "تعيين المراجع الخارجي من الجمعية العامة بناء على توصية لجنة المراجعة", "Appoint external auditor by GA based on audit committee recommendation", "نظام الشركات", "المادة 132", "نظام حوكمة الشركة", "POL-GOV-002", "وزارة التجارة", "إلزامي", "المراجعة الداخلية", "رئيس لجنة المراجعة", "مدير الالتزام", "خط الدفاع الثالث", "سنوي", null, null, null, 60, "حرج", 1, 5, null, null, "بطلان القوائم المالية / غرامة", "ملتزم", 1, "تقييم سنوي للمراجعين / معايير الاختيار", "مراجعة وثائقية", "مجتاز", null, "محضر الجمعية / خطاب التعيين", null, null, null, null, null, "GOV-R-222", null, null],
  ["CMP-COC-001", 111, "قواعد السلوك والأخلاقيات", "الامتثال العام", "الامتثال للقوانين والقواعد واللوائح التنظيمية المطبقة", "Comply with all applicable laws, rules and regulations", "نظام الشركات / لائحة الحوكمة", null, "قواعد السلوك المهني", "POL-GOV-009", "هيئة السوق المالية (CMA)", "إلزامي", "الالتزام والحوكمة", "مدير الالتزام", null, "خط الدفاع الثاني", "مستمر", null, null, null, 0, "حرج", 2, 4, null, null, "غرامات / مسؤولية قانونية", "ملتزم", 1, "تدريب سنوي / توقيع إقرارات / متابعة دورية", "تقييم ذاتي", "مجتاز", null, "سجل التدريبات / الإقرارات الموقعة", null, null, null, null, null, "COM-R-755", null, null],
  ["CMP-ISO-001", 112, "إدارة الجودة", "ISO 9001", "الحفاظ على شهادة ISO 9001 وتجديدها", "Maintain and renew ISO 9001 certification", "ISO 9001:2015", null, "سياسة الجودة", "POL-QA-001", "جهة الاعتماد الدولية", "اختياري (أفضل الممارسات)", "ضمان الجودة", "مدير الجودة", null, "خط الدفاع الأول", "سنوي", null, null, null, 120, "مرتفع", 2, 3, null, null, "فقدان الشهادة / تأثير على العقود والسمعة", "ملتزم", 1, "مراجعات داخلية / مراجعة خارجية سنوية", "مراجعة خارجية", "مجتاز", null, "شهادة ISO / تقارير المراجعة الداخلية", null, null, null, null, null, "OPR-001", "KRI-QA-02", null],
  ["CMP-CUS-001", 113, "الجمارك والاستيراد/التصدير", "الإجراءات الجمركية", "الالتزام بإجراءات التخليص الجمركي واستيراد المواد الخام", "Comply with customs clearance procedures for raw material imports", "نظام الجمارك الموحد", "المادة 5", "سياسة المشتريات", "POL-SC-001", "هيئة الزكاة والضريبة والجمارك (ZATCA)", "إلزامي", "سلسلة الإمداد", "مدير سلسلة الإمداد", "مخلص جمركي", "خط الدفاع الأول", "مستمر", null, null, null, 0, "مرتفع", 2, 4, null, null, "غرامة / مصادرة بضائع / تأخير إنتاج", "ملتزم", 1, "مخلص جمركي معتمد / مراجعة المستندات", "فحص ميداني", "مجتاز", null, "البيانات الجمركية / شهادات المنشأ", null, null, null, null, null, "OPR-001", null, null],
  ["CMP-CSR-001", 114, "المسؤولية الاجتماعية", "السياسة", "اعتماد وتطبيق سياسة المسؤولية الاجتماعية", "Adopt and implement CSR policy", "لائحة الحوكمة", "المادة 87", "لائحة المسؤولية الاجتماعية 2024", "POL-GOV-010", "هيئة السوق المالية (CMA)", "استرشادي", "الالتزام والحوكمة", "مدير الالتزام", null, "خط الدفاع الثاني", "سنوي", null, null, null, 60, "منخفض", 1, 2, null, null, "ملاحظة في تقرير الحوكمة (استرشادي)", "ملتزم", 1, "سياسة معتمدة / تقرير سنوي", "مراجعة وثائقية", "مجتاز", null, "سياسة CSR / التقرير السنوي", null, null, null, null, null, null, null, null],
  ["CMP-AUM-001", 115, "مصفوفة الصلاحيات", "الصلاحيات", "الالتزام بحدود الصلاحيات المحددة لكل مستوى إداري", "Comply with authority limits per management level", "سياسة داخلية", null, "مصفوفة الصلاحيات", "POL-GOV-011", "مجلس الإدارة (داخلي)", "إلزامي", "الالتزام والحوكمة", "مدير الالتزام", null, "خط الدفاع الثاني", "مستمر", null, null, null, 0, "مرتفع", 3, 4, null, null, "تجاوز صلاحيات / مسؤولية شخصية", "ملتزم جزئياً", 0.7, "مصفوفة صلاحيات معتمدة / نظام ERP", "فحص ميداني", "جزئي", null, "مصفوفة الصلاحيات / تقارير التجاوزات", "بعض الصلاحيات بحاجة لتحديث", "تحديث مصفوفة الصلاحيات", "2026-06-30", "مدير الالتزام", "قيد التنفيذ", "GOV-R-223", null, null],
  ["CMP-IP-001", 116, "الملكية الفكرية", "العلامات التجارية", "تجديد تسجيل العلامات التجارية للشركة", "Renew company trademark registrations", "نظام العلامات التجارية", null, null, null, "الهيئة السعودية للملكية الفكرية", "إلزامي", "القانونية", "المستشار القانوني", null, "خط الدفاع الأول", "سنوي", null, null, null, 90, "متوسط", 1, 3, null, null, "فقدان حماية العلامة التجارية", "ملتزم", 1, "تقويم تجديد / متابعة المحامي", "مراجعة وثائقية", "مجتاز", null, "شهادات التسجيل / إشعارات التجديد", null, null, null, null, null, null, null, null],
];


export async function POST() {
  try {
    const session = await auth();

    if (!session?.user?.id || session.user.role !== 'admin') {
      return NextResponse.json(
        { success: false, error: 'غير مصرح - يجب أن تكون مسؤول النظام' },
        { status: 403 }
      );
    }

    // Check if data already exists
    const existingCount = await prisma.complianceObligation.count();
    if (existingCount > 0) {
      return NextResponse.json({
        success: false,
        error: 'بيانات الالتزام موجودة بالفعل. عدد السجلات الحالية: ' + existingCount,
        existingCount,
      }, { status: 400 });
    }

    // --- Collect unique domains and regulatory bodies ---
    const domainsMap = new Map<string, { code: string; nameAr: string; nameEn: string; order: number }>();
    const regBodiesMap = new Map<string, { code: string; nameAr: string; nameEn: string }>();

    let domainOrder = 0;
    for (const row of obligationsData) {
      const domainAr = row[2] as string;
      if (!domainsMap.has(domainAr)) {
        domainOrder++;
        domainsMap.set(domainAr, {
          code: extractDomainCode(row[0] as string),
          nameAr: domainAr,
          nameEn: domainArToEn[domainAr] || domainAr,
          order: domainOrder,
        });
      }

      const regBodyAr = row[10] as string | null;
      if (regBodyAr && !regBodiesMap.has(regBodyAr)) {
        regBodiesMap.set(regBodyAr, {
          code: regulatoryBodyArToCode[regBodyAr] || regBodyAr,
          nameAr: regBodyAr,
          nameEn: regulatoryBodyArToEn[regBodyAr] || regBodyAr,
        });
      }
    }

    // --- Execute in a transaction ---
    const result = await prisma.$transaction(async (tx) => {
      // 1. Create ComplianceDomain records
      const domainIdMap = new Map<string, string>();
      for (const [nameAr, domain] of domainsMap) {
        const created = await tx.complianceDomain.create({
          data: {
            code: domain.code,
            nameAr: domain.nameAr,
            nameEn: domain.nameEn,
            order: domain.order,
          },
        });
        domainIdMap.set(nameAr, created.id);
      }

      // 2. Create RegulatoryBody records
      const regBodyIdMap = new Map<string, string>();
      for (const [nameAr, body] of regBodiesMap) {
        const created = await tx.regulatoryBody.create({
          data: {
            code: body.code,
            nameAr: body.nameAr,
            nameEn: body.nameEn,
          },
        });
        regBodyIdMap.set(nameAr, created.id);
      }

      // 3. Create all 68 ComplianceObligation records
      const obligationIds: { id: string; code: string; linkedRiskNumbers: string | null }[] = [];

      for (const row of obligationsData) {
        const [
          code, seq, domainAr, subDomainAr, titleAr, titleEn,
          regulatoryRef, articleNum, internalPolicyAr, policyDocNum,
          regulatoryBodyAr, obligationTypeAr, responsibleDeptAr,
          directOwnerAr, backupOwnerAr, defenseLineAr, recurrenceAr,
          nextDueDate, lastReviewDate, nextReviewDate, alertDays,
          criticalityAr, likelihood, impact, _riskScore, _riskRating,
          penaltiesAr, statusAr, completionPct, controlActivitiesAr,
          testingMethodAr, lastTestResultAr, lastTestDate, evidenceReqAr,
          gapDescAr, remediationPlanAr, remediationTargetDate,
          remediationOwnerAr, remediationStatusAr, linkedRiskNumbers,
          kpiKri, notes,
        ] = row;

        // Compute risk score and rating
        const lk = (likelihood as number | null) || 0;
        const imp = (impact as number | null) || 0;
        const riskScore = lk * imp;
        const riskRating = riskScore > 0 ? computeRiskRating(riskScore) : null;

        const domainId = domainIdMap.get(domainAr as string) || '';
        const regBodyId = regulatoryBodyAr ? regBodyIdMap.get(regulatoryBodyAr as string) || null : null;

        const obligation = await tx.complianceObligation.create({
          data: {
            code: code as string,
            sequenceNumber: seq as number,
            domainId,
            subDomainAr: subDomainAr as string,
            titleAr: titleAr as string,
            titleEn: titleEn as string,
            regulatoryReference: regulatoryRef as string | null,
            articleNumber: articleNum as string | null,
            internalPolicyAr: internalPolicyAr as string | null,
            policyDocumentNumber: policyDocNum as string | null,
            regulatoryBodyId: regBodyId,
            obligationType: obligationTypeArToEnum[(obligationTypeAr as string)] || 'mandatory',
            responsibleDepartmentAr: responsibleDeptAr as string | null,
            directOwnerAr: directOwnerAr as string | null,
            backupOwnerAr: backupOwnerAr as string | null,
            defenseLine: defenseLineAr ? defenseLineArToEnum[(defenseLineAr as string)] || null : null,
            recurrence: recurrenceAr ? recurrenceArToEnum[(recurrenceAr as string)] || null : null,
            nextDueDate: nextDueDate ? new Date(nextDueDate as string) : null,
            lastReviewDate: lastReviewDate ? new Date(lastReviewDate as string) : null,
            nextReviewDate: nextReviewDate ? new Date(nextReviewDate as string) : null,
            alertDaysBefore: (alertDays as number | null) ?? 30,
            criticalityLevel: criticalityAr ? criticalityArToEnum[(criticalityAr as string)] || null : null,
            nonComplianceLikelihood: likelihood as number | null,
            nonComplianceImpact: impact as number | null,
            riskScore: riskScore > 0 ? riskScore : null,
            riskRating,
            potentialPenaltiesAr: penaltiesAr as string | null,
            complianceStatus: statusAr ? statusArToEnum[(statusAr as string)] || 'notAssessed' : 'notAssessed',
            completionPercentage: (completionPct as number | null) ?? 0,
            controlActivitiesAr: controlActivitiesAr as string | null,
            testingMethod: testingMethodAr ? testingMethodArToEnum[(testingMethodAr as string)] || null : null,
            lastTestResult: lastTestResultAr ? testResultArToEnum[(lastTestResultAr as string)] || null : null,
            lastTestDate: lastTestDate ? new Date(lastTestDate as string) : null,
            evidenceRequirementsAr: evidenceReqAr as string | null,
            gapDescriptionAr: gapDescAr as string | null,
            remediationPlanAr: remediationPlanAr as string | null,
            remediationTargetDate: remediationTargetDate ? new Date(remediationTargetDate as string) : null,
            remediationOwnerAr: remediationOwnerAr as string | null,
            remediationStatus: remediationStatusAr ? remediationStatusArToEnum[(remediationStatusAr as string)] || null : null,
            linkedRiskNumbers: linkedRiskNumbers as string | null,
            kpiKriAr: kpiKri as string | null,
            notesAr: notes as string | null,
            createdById: session.user.id,
          },
        });

        obligationIds.push({
          id: obligation.id,
          code: obligation.code,
          linkedRiskNumbers: linkedRiskNumbers as string | null,
        });
      }

      // 4. Auto-link to risks by matching linkedRiskNumbers to Risk.riskNumber
      let riskLinksCreated = 0;

      for (const { id: obligationId, linkedRiskNumbers } of obligationIds) {
        if (!linkedRiskNumbers) continue;

        const riskNumbers = linkedRiskNumbers
          .split(',')
          .map((r) => r.trim())
          .filter(Boolean);

        for (const riskNumber of riskNumbers) {
          const risk = await tx.risk.findFirst({
            where: { riskNumber, isDeleted: false },
            select: { id: true },
          });

          if (risk) {
            await tx.complianceRiskLink.create({
              data: {
                obligationId,
                riskId: risk.id,
              },
            });
            riskLinksCreated++;
          }
        }
      }

      return {
        domains: domainsMap.size,
        regulatoryBodies: regBodiesMap.size,
        obligations: obligationIds.length,
        riskLinks: riskLinksCreated,
      };
    });

    return NextResponse.json({
      success: true,
      message: 'تم استيراد بيانات الالتزام بنجاح',
      summary: {
        domainsCreated: result.domains,
        regulatoryBodiesCreated: result.regulatoryBodies,
        obligationsCreated: result.obligations,
        riskLinksCreated: result.riskLinks,
      },
    });
  } catch (error) {
    console.error('Compliance seed error:', error);
    return NextResponse.json(
      {
        success: false,
        error: 'حدث خطأ أثناء استيراد البيانات',
        details: error instanceof Error ? error.message : String(error),
      },
      { status: 500 }
    );
  }
}
